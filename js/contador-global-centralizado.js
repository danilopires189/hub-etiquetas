// Sistema de Contador Global Centralizado para GitHub Pages
// Este arquivo garante que TODAS as aplica√ß√µes compartilhem o mesmo contador

class ContadorGlobalCentralizado {
  constructor() {
    this.config = this.detectarConfiguracao();
    this.valorInicial = 83430;
    this.chaveStorage = 'contador_global_centralizado_v1';
    this.intervaloSync = 30000; // 30 segundos
    this.isOnline = navigator.onLine;
    this.operacoesPendentes = [];
    
    console.log('üåê Contador Global Centralizado inicializado');
    console.log(`üìä Configura√ß√£o: ${this.config.owner}/${this.config.repo}`);
    
    this.inicializar();
  }
  
  // Detectar configura√ß√£o automaticamente
  detectarConfiguracao() {
    const hostname = window.location.hostname;
    const pathname = window.location.pathname;
    
    if (hostname.endsWith('.github.io')) {
      // GitHub Pages - auto-detectar
      const owner = hostname.split('.')[0];
      const pathParts = pathname.split('/').filter(p => p);
      const repo = pathParts[0] || `${owner}.github.io`;
      
      console.log(`üîç GitHub Pages detectado: ${owner}/${repo}`);
      
      return {
        owner,
        repo,
        branch: 'main',
        autoDetectado: true,
        isGitHubPages: true
      };
    }
    
    // Desenvolvimento local
    console.log('üè† Modo desenvolvimento local detectado');
    return {
      owner: 'SEU_USUARIO_GITHUB',
      repo: 'SEU_REPOSITORIO',
      branch: 'main',
      autoDetectado: false,
      isGitHubPages: false
    };
  }
  
  async inicializar() {
    try {
      // Carregar estado local primeiro (sempre funciona)
      await this.carregarEstadoLocal();
      
      // Tentar sincronizar com GitHub se dispon√≠vel (n√£o cr√≠tico)
      if (this.config.isGitHubPages) {
        try {
          await this.sincronizarComGitHub();
        } catch (syncError) {
          console.warn('‚ö†Ô∏è Sincroniza√ß√£o falhou, continuando com localStorage:', syncError.message);
        }
      } else {
        console.log('üè† Modo local: usando apenas armazenamento local');
      }
      
      // Configurar monitoramento de conectividade
      this.configurarMonitoramentoConectividade();
      
      // Iniciar sincroniza√ß√£o peri√≥dica
      this.iniciarSincronizacaoPeriodica();
      
      console.log('‚úÖ Contador Global Centralizado pronto');
      console.log(`üìä Valor atual: ${this.valorAtual} etiquetas`);
      console.log(`üåê Modo: ${this.config.isGitHubPages ? 'GitHub Pages' : 'Local'}`);
      
    } catch (error) {
      console.warn('‚ö†Ô∏è Erro na inicializa√ß√£o:', error.message);
      // Continuar com estado local como fallback
      this.valorAtual = this.valorInicial;
      this.ultimaAtualizacao = new Date().toISOString();
      console.log('üîÑ Usando valores padr√£o como fallback');
    }
  }
  
  // Carregar estado local
  async carregarEstadoLocal() {
    try {
      const dados = localStorage.getItem(this.chaveStorage);
      if (dados) {
        const parsed = JSON.parse(dados);
        this.valorAtual = parsed.totalEtiquetas || this.valorInicial;
        this.ultimaAtualizacao = parsed.ultimaAtualizacao;
        this.operacoesPendentes = parsed.operacoesPendentes || [];
        
        console.log(`üì± Estado local carregado: ${this.valorAtual} etiquetas`);
      } else {
        // Se n√£o h√° dados locais, usar valor inicial e salvar
        this.valorAtual = this.valorInicial;
        this.ultimaAtualizacao = new Date().toISOString();
        this.operacoesPendentes = [];
        
        // Salvar estado inicial no localStorage
        await this.salvarEstadoLocal();
        
        console.log(`üÜï Estado inicial criado e salvo: ${this.valorAtual} etiquetas`);
      }
    } catch (error) {
      console.warn('‚ö†Ô∏è Erro ao carregar estado local:', error);
      this.valorAtual = this.valorInicial;
      this.ultimaAtualizacao = new Date().toISOString();
      this.operacoesPendentes = [];
      
      // Tentar salvar mesmo com erro
      try {
        await this.salvarEstadoLocal();
      } catch (saveError) {
        console.warn('‚ö†Ô∏è Erro ao salvar estado inicial:', saveError);
      }
    }
  }
  
  // Salvar estado local
  async salvarEstadoLocal() {
    try {
      const dados = {
        totalEtiquetas: this.valorAtual,
        ultimaAtualizacao: this.ultimaAtualizacao,
        operacoesPendentes: this.operacoesPendentes,
        timestamp: Date.now()
      };
      
      localStorage.setItem(this.chaveStorage, JSON.stringify(dados));
      console.log(`üíæ Estado local salvo: ${this.valorAtual} etiquetas`);
      
    } catch (error) {
      console.warn('‚ö†Ô∏è Erro ao salvar estado local:', error);
    }
  }
  
  // Sincronizar com GitHub (modo simplificado para GitHub Pages)
  async sincronizarComGitHub() {
    if (!this.config.isGitHubPages) {
      console.log('‚ÑπÔ∏è N√£o √© GitHub Pages, usando apenas localStorage');
      return;
    }
    
    try {
      // Tentar obter dados do GitHub (apenas leitura)
      const url = `https://raw.githubusercontent.com/${this.config.owner}/${this.config.repo}/main/data/contador.json?t=${Date.now()}`;
      const response = await fetch(url);
      
      if (response.ok) {
        const dadosGitHub = await response.json();
        const valorGitHub = dadosGitHub.totalEtiquetas || this.valorInicial;
        
        // Usar o valor do GitHub apenas se for maior que o local
        if (valorGitHub > this.valorAtual) {
          console.log(`üîÑ Sincronizando do GitHub: ${this.valorAtual} ‚Üí ${valorGitHub}`);
          this.valorAtual = valorGitHub;
          this.ultimaAtualizacao = dadosGitHub.ultimaAtualizacao || new Date().toISOString();
          
          // Salvar estado atualizado
          await this.salvarEstadoLocal();
        } else if (this.valorAtual > valorGitHub) {
          console.log(`üìä Valor local (${this.valorAtual}) √© maior que GitHub (${valorGitHub}), mantendo local`);
        }
        
        console.log(`‚úÖ Sincroniza√ß√£o conclu√≠da: ${this.valorAtual} etiquetas`);
        
      } else {
        console.log('‚ÑπÔ∏è Arquivo n√£o encontrado no GitHub, usando estado local');
        // No GitHub Pages, n√£o podemos criar arquivos, ent√£o apenas usar localStorage
        console.log('üíæ GitHub Pages: usando apenas localStorage para persist√™ncia');
      }
      
    } catch (error) {
      console.warn('‚ö†Ô∏è Erro na sincroniza√ß√£o com GitHub:', error.message);
      console.log('üíæ Continuando com localStorage apenas');
    }
  }
  
  // No GitHub Pages, n√£o podemos criar arquivos no reposit√≥rio
  // Esta fun√ß√£o foi removida pois n√£o √© necess√°ria
  
  // Incrementar contador
  async incrementar(quantidade = 1, tipo = 'geral') {
    try {
      // Validar quantidade
      if (quantidade <= 0) {
        throw new Error('Quantidade deve ser positiva');
      }
      
      // Garantir que o valor atual est√° definido
      if (typeof this.valorAtual !== 'number') {
        this.valorAtual = this.valorInicial;
      }
      
      // Incrementar valor
      const valorAnterior = this.valorAtual;
      this.valorAtual += quantidade;
      this.ultimaAtualizacao = new Date().toISOString();
      
      // Adicionar √† lista de opera√ß√µes pendentes
      this.operacoesPendentes.push({
        quantidade,
        tipo,
        valorAnterior,
        valorNovo: this.valorAtual,
        timestamp: this.ultimaAtualizacao
      });
      
      // Salvar estado local
      await this.salvarEstadoLocal();
      
      // Tentar sincronizar com GitHub (em background)
      if (this.config.isGitHubPages) {
        this.sincronizarComGitHub().catch(() => {
          // Falha silenciosa - ser√° tentado novamente na pr√≥xima sincroniza√ß√£o
        });
      }
      
      console.log(`üìà Contador incrementado: +${quantidade} ${tipo} = ${this.valorAtual}`);
      console.log(`üíæ Estado salvo localmente`);
      
      // Disparar evento
      this.dispararEvento('incremento', {
        quantidade,
        tipo,
        valorAnterior,
        valorAtual: this.valorAtual
      });
      
      // Disparar evento customizado para o hub
      window.dispatchEvent(new CustomEvent('contador-atualizado', {
        detail: {
          valor: this.valorAtual,
          incremento: quantidade,
          tipo: tipo
        }
      }));
      
      // Disparar evento para todas as janelas (cross-window communication)
      if (window.localStorage) {
        localStorage.setItem('contador_ultimo_incremento', JSON.stringify({
          valor: this.valorAtual,
          incremento: quantidade,
          tipo: tipo,
          timestamp: Date.now()
        }));
      }
      
      return this.valorAtual;
      
    } catch (error) {
      console.error('‚ùå Erro ao incrementar contador:', error);
      throw error;
    }
  }
  
  // Obter valor atual
  obterValor() {
    return this.valorAtual;
  }
  
  // Obter estat√≠sticas
  obterEstatisticas() {
    return {
      valorAtual: this.valorAtual,
      ultimaAtualizacao: this.ultimaAtualizacao,
      operacoesPendentes: this.operacoesPendentes.length,
      isOnline: this.isOnline,
      configuracao: this.config
    };
  }
  
  // Configurar monitoramento de conectividade
  configurarMonitoramentoConectividade() {
    window.addEventListener('online', () => {
      this.isOnline = true;
      console.log('üåê Conectividade restaurada');
      this.sincronizarComGitHub();
    });
    
    window.addEventListener('offline', () => {
      this.isOnline = false;
      console.log('üì± Modo offline ativado');
    });
  }
  
  // Iniciar sincroniza√ß√£o peri√≥dica
  iniciarSincronizacaoPeriodica() {
    if (!this.config.isGitHubPages) return;
    
    setInterval(() => {
      if (this.isOnline) {
        console.log('üîÑ Sincroniza√ß√£o peri√≥dica...');
        this.sincronizarComGitHub();
      }
    }, this.intervaloSync);
  }
  
  // Sistema de eventos
  dispararEvento(tipo, dados) {
    const evento = new CustomEvent(`contador-${tipo}`, { detail: dados });
    window.dispatchEvent(evento);
  }
  
  // M√©todo de compatibilidade
  async incrementarContador(quantidade = 1, tipo = 'geral') {
    return await this.incrementar(quantidade, tipo);
  }
  
  // M√©todo de compatibilidade
  async obterContador() {
    return { totalEtiquetas: this.valorAtual };
  }
}

// Criar inst√¢ncia global
window.contadorGlobal = new ContadorGlobalCentralizado();

// API global para compatibilidade
window.HubEtiquetas = {
  incrementarContador: (quantidade, tipo) => window.contadorGlobal.incrementarContador(quantidade, tipo),
  obterContador: () => window.contadorGlobal.obterContador(),
  obterValor: () => window.contadorGlobal.obterValor(),
  obterEstatisticas: () => window.contadorGlobal.obterEstatisticas(),
  disponivel: () => true
};

console.log('üöÄ Sistema de Contador Global Centralizado carregado');



