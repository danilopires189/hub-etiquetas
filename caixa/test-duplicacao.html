<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Duplica√ß√£o - Caixa</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-case { 
            border: 1px solid #ddd; 
            margin: 10px 0; 
            padding: 15px; 
            border-radius: 5px; 
        }
        .success { background: #d4edda; border-color: #c3e6cb; }
        .error { background: #f8d7da; border-color: #f5c6cb; }
        .warning { background: #fff3cd; border-color: #ffeaa7; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .results { margin-top: 10px; font-family: monospace; }
    </style>
</head>
<body>
    <h1>üß™ Teste de Duplica√ß√£o - M√≥dulo Caixa</h1>
    
    <div class="test-case">
        <h3>Teste 1: Externa - 8 n√∫meros, 2 c√≥pias</h3>
        <p>Esperado: 16 etiquetas (8 √ó 2)</p>
        <button onclick="testCase1()">Executar Teste</button>
        <div id="result1" class="results"></div>
    </div>
    
    <div class="test-case">
        <h3>Teste 2: Interna - 8 n√∫meros</h3>
        <p>Esperado: 16 etiquetas (8 √ó 2 fixo)</p>
        <button onclick="testCase2()">Executar Teste</button>
        <div id="result2" class="results"></div>
    </div>
    
    <div class="test-case">
        <h3>Teste 3: Ambas - 8 n√∫meros, 2 c√≥pias</h3>
        <p>Esperado: 32 etiquetas (8√ó2 externas + 8√ó2 internas)</p>
        <button onclick="testCase3()">Executar Teste</button>
        <div id="result3" class="results"></div>
    </div>
    
    <div class="test-case">
        <h3>Teste 4: Ambas - 10 n√∫meros, 3 c√≥pias</h3>
        <p>Esperado: 50 etiquetas (10√ó3 externas + 10√ó2 internas)</p>
        <button onclick="testCase4()">Executar Teste</button>
        <div id="result4" class="results"></div>
    </div>

    <script>
        // Simular as fun√ß√µes necess√°rias
        const padLeft = (numStr, len) => (Array(len + 1).join('0') + numStr).slice(-len);
        
        function dvMod10_31(base) {
            let s = 0, n = base.length;
            for (let i = 0; i < n; i++) {
                const d = base.charCodeAt(i) - 48;
                const w = ((n - 1 - i) % 2 === 0) ? 1 : 3;
                s += d * w;
            }
            return (10 - (s % 10)) % 10;
        }

        function simulateGeneration(base, qtd, copias, labelType) {
            const results = [];
            const len = base.length;
            
            console.log(`Simulando: Base=${base}, Qtd=${qtd}, C√≥pias=${copias}, Tipo=${labelType}`);
            
            if (labelType === 'external') {
                for (let i = 0; i < qtd; i++) {
                    const atual = padLeft(String(parseInt(base, 10) + i), len);
                    const dv = dvMod10_31(atual);
                    const payloadBase = (atual.length % 2 === 0) ? atual : ('0' + atual);
                    
                    for (let c = 0; c < copias; c++) {
                        results.push({
                            type: 'external',
                            numero: payloadBase,
                            dv: dv,
                            copia: c + 1
                        });
                    }
                }
            } else if (labelType === 'internal') {
                for (let i = 0; i < qtd; i++) {
                    const atual = padLeft(String(parseInt(base, 10) + i), len);
                    const last4 = atual.slice(-4);
                    
                    for (let k = 0; k < 2; k++) {
                        results.push({
                            type: 'internal',
                            numero: last4,
                            dv: null,
                            copia: k + 1
                        });
                    }
                }
            } else if (labelType === 'both') {
                // Primeiro todas as externas
                for (let i = 0; i < qtd; i++) {
                    const atual = padLeft(String(parseInt(base, 10) + i), len);
                    const dv = dvMod10_31(atual);
                    const payloadBase = (atual.length % 2 === 0) ? atual : ('0' + atual);
                    
                    for (let c = 0; c < copias; c++) {
                        results.push({
                            type: 'external',
                            numero: payloadBase,
                            dv: dv,
                            copia: c + 1
                        });
                    }
                }
                
                // Depois todas as internas
                for (let i = 0; i < qtd; i++) {
                    const atual = padLeft(String(parseInt(base, 10) + i), len);
                    const last4 = atual.slice(-4);
                    
                    for (let k = 0; k < 2; k++) {
                        results.push({
                            type: 'internal',
                            numero: last4,
                            dv: null,
                            copia: k + 1
                        });
                    }
                }
            }
            
            return results;
        }

        function analyzeResults(results, expected, testId) {
            const resultDiv = document.getElementById(`result${testId}`);
            const testCase = resultDiv.parentElement;
            
            let analysis = `Total gerado: ${results.length}\n`;
            analysis += `Total esperado: ${expected}\n`;
            
            // Contar por tipo
            const external = results.filter(r => r.type === 'external').length;
            const internal = results.filter(r => r.type === 'internal').length;
            
            analysis += `Externas: ${external}\n`;
            analysis += `Internas: ${internal}\n`;
            
            // Verificar duplicatas
            const seen = new Set();
            const duplicates = [];
            
            results.forEach((item, index) => {
                const key = `${item.type}-${item.numero}-${item.dv}-${item.copia}`;
                if (seen.has(key)) {
                    duplicates.push({ index, item, key });
                } else {
                    seen.add(key);
                }
            });
            
            if (duplicates.length > 0) {
                analysis += `\n‚ùå DUPLICATAS ENCONTRADAS: ${duplicates.length}\n`;
                duplicates.forEach(dup => {
                    analysis += `  - ${dup.key} (posi√ß√£o ${dup.index})\n`;
                });
                testCase.className = 'test-case error';
            } else if (results.length === expected) {
                analysis += `\n‚úÖ TESTE PASSOU - Sem duplicatas, quantidade correta`;
                testCase.className = 'test-case success';
            } else {
                analysis += `\n‚ö†Ô∏è QUANTIDADE INCORRETA`;
                testCase.className = 'test-case warning';
            }
            
            resultDiv.textContent = analysis;
        }

        function testCase1() {
            const results = simulateGeneration('564742', 8, 2, 'external');
            analyzeResults(results, 16, 1);
        }

        function testCase2() {
            const results = simulateGeneration('564742', 8, 2, 'internal');
            analyzeResults(results, 16, 2);
        }

        function testCase3() {
            const results = simulateGeneration('564742', 8, 2, 'both');
            analyzeResults(results, 32, 3);
        }

        function testCase4() {
            const results = simulateGeneration('564742', 10, 3, 'both');
            analyzeResults(results, 50, 4);
        }

        // Executar todos os testes automaticamente
        window.addEventListener('load', () => {
            console.log('üß™ Executando testes de duplica√ß√£o...');
            setTimeout(() => {
                testCase1();
                testCase2();
                testCase3();
                testCase4();
            }, 500);
        });
    </script>
</body>
</html>