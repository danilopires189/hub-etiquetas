<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verifica√ß√£o de Tabelas Supabase - Hub de Etiquetas</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: #f9f9f9;
        }
        
        .status-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .status-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .status-card.complete {
            border-left: 4px solid #10b981;
        }
        
        .status-card.incomplete {
            border-left: 4px solid #f59e0b;
        }
        
        .status-card .value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .status-card.complete .value {
            color: #10b981;
        }
        
        .status-card.incomplete .value {
            color: #f59e0b;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .table-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .table-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .table-item.ok {
            border-left: 4px solid #10b981;
        }
        
        .table-item.missing {
            border-left: 4px solid #ef4444;
        }
        
        .table-item h4 {
            color: #333;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .table-item p {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 8px;
        }
        
        .table-item .source {
            font-size: 0.8em;
            color: #888;
            font-style: italic;
        }
        
        .log {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        
        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }
        
        .instructions {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .instructions h3 {
            color: #0c4a6e;
            margin-bottom: 10px;
        }
        
        .instructions ol {
            margin-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 5px;
            color: #0c4a6e;
        }
        
        .sql-files {
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .sql-files h4 {
            color: #334155;
            margin-bottom: 10px;
        }
        
        .sql-files ul {
            margin-left: 20px;
        }
        
        .sql-files li {
            margin-bottom: 5px;
            color: #475569;
        }
        
        code {
            background: #f1f5f9;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            color: #1e293b;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Verifica√ß√£o de Tabelas Supabase</h1>
            <p>Hub de Etiquetas - Verifica√ß√£o do Banco de Dados</p>
        </div>
        
        <div class="content">
            <!-- Instru√ß√µes -->
            <div class="instructions">
                <h3>üìã Como usar esta verifica√ß√£o:</h3>
                <ol>
                    <li>Clique em "Executar Verifica√ß√£o" para testar a conex√£o com o Supabase</li>
                    <li>Se houver tabelas/fun√ß√µes faltando, execute os arquivos SQL listados</li>
                    <li>Acesse o painel do Supabase ‚Üí SQL Editor</li>
                    <li>Copie e execute o conte√∫do dos arquivos SQL necess√°rios</li>
                    <li>Execute a verifica√ß√£o novamente</li>
                </ol>
            </div>
            
            <!-- Status Geral -->
            <div class="section">
                <h2>üìä Status Geral do Sistema</h2>
                <div class="status-overview">
                    <div class="status-card" id="system-status-card">
                        <h3>Sistema</h3>
                        <div class="value" id="system-status">-</div>
                        <p id="system-status-text">Aguardando verifica√ß√£o</p>
                    </div>
                    <div class="status-card" id="tables-status-card">
                        <h3>Tabelas</h3>
                        <div class="value" id="tables-status">-/-</div>
                        <p>Existentes / Necess√°rias</p>
                    </div>
                    <div class="status-card" id="functions-status-card">
                        <h3>Fun√ß√µes</h3>
                        <div class="value" id="functions-status">-/-</div>
                        <p>Existentes / Necess√°rias</p>
                    </div>
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="overall-progress" style="width: 0%"></div>
                </div>
                
                <button class="btn" onclick="runVerification()" id="verify-btn">
                    üîç Executar Verifica√ß√£o
                </button>
            </div>
            
            <!-- Alertas -->
            <div id="alerts-container"></div>
            
            <!-- Detalhes das Tabelas -->
            <div class="section" id="tables-section" style="display: none;">
                <h2>üìã Detalhes das Tabelas</h2>
                <div class="table-list" id="tables-list">
                    <!-- Ser√° preenchido dinamicamente -->
                </div>
            </div>
            
            <!-- Detalhes das Fun√ß√µes -->
            <div class="section" id="functions-section" style="display: none;">
                <h2>‚öôÔ∏è Detalhes das Fun√ß√µes</h2>
                <div class="table-list" id="functions-list">
                    <!-- Ser√° preenchido dinamicamente -->
                </div>
            </div>
            
            <!-- Arquivos SQL Necess√°rios -->
            <div class="sql-files">
                <h4>üìÅ Arquivos SQL do Sistema:</h4>
                <ul>
                    <li><code>supabase/schema.sql</code> - Tabelas principais e fun√ß√µes b√°sicas</li>
                    <li><code>supabase/application-history-schema.sql</code> - Sistema de hist√≥rico</li>
                    <li><code>supabase/conflict-resolution-functions.sql</code> - Resolu√ß√£o de conflitos</li>
                </ul>
            </div>
            
            <!-- Log de Verifica√ß√£o -->
            <div class="section">
                <h2>üìù Log de Verifica√ß√£o</h2>
                <div class="log" id="verification-log">Aguardando verifica√ß√£o...</div>
                <button class="btn" onclick="clearLog()">üßπ Limpar Log</button>
            </div>
        </div>
    </div>

    <!-- Script Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script>
        // Configura√ß√£o do Supabase
        const SUPABASE_URL = 'https://jomwkkhhhekbyanftpoc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpvbXdra2hoaGVrYnlhbmZ0cG9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY1MjU0NzQsImV4cCI6MjA1MjEwMTQ3NH0.Ej4Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Lista de tabelas necess√°rias
        const REQUIRED_TABLES = {
            'labels': {
                description: 'Registro de todas as gera√ß√µes de etiquetas',
                required_columns: ['id', 'application_type', 'quantity', 'copies', 'created_at'],
                source_file: 'schema.sql'
            },
            'global_counter': {
                description: 'Contador global centralizado de etiquetas',
                required_columns: ['id', 'total_count', 'application_breakdown', 'last_updated', 'version'],
                source_file: 'schema.sql'
            },
            'user_sessions': {
                description: 'Sess√µes de usu√°rio para rastreamento',
                required_columns: ['id', 'session_id', 'created_at', 'is_active'],
                source_file: 'schema.sql'
            },
            'application_stats': {
                description: 'Estat√≠sticas agregadas por aplica√ß√£o',
                required_columns: ['id', 'application_type', 'date', 'total_generations', 'total_labels'],
                source_file: 'schema.sql'
            },
            'application_history': {
                description: 'Hist√≥rico de gera√ß√µes por aplica√ß√£o (localStorage + Supabase)',
                required_columns: ['id', 'application_type', 'quantity', 'copies', 'unique_key', 'created_at'],
                source_file: 'application-history-schema.sql'
            },
            'conflict_resolution_log': {
                description: 'Log de resolu√ß√µes de conflito do sistema',
                required_columns: ['id', 'data_type', 'resolution_strategy', 'created_at'],
                source_file: 'conflict-resolution-functions.sql'
            }
        };

        // Lista de fun√ß√µes necess√°rias
        const REQUIRED_FUNCTIONS = {
            'update_global_counter': {
                description: 'Atualiza contador global de forma thread-safe',
                parameters: ['increment_amount', 'app_type'],
                source_file: 'schema.sql'
            },
            'get_counter_stats': {
                description: 'Obt√©m estat√≠sticas do contador global',
                parameters: [],
                source_file: 'schema.sql'
            },
            'register_label_generation': {
                description: 'Registra nova gera√ß√£o de etiquetas',
                parameters: ['p_application_type', 'p_quantity', 'p_copies'],
                source_file: 'schema.sql'
            },
            'migrate_global_counter': {
                description: 'Migra dados do localStorage para Supabase',
                parameters: ['p_total_count', 'p_application_breakdown'],
                source_file: 'schema.sql'
            },
            'apply_resolved_counter': {
                description: 'Aplica dados resolvidos ap√≥s conflito',
                parameters: ['p_total_count', 'p_application_breakdown'],
                source_file: 'conflict-resolution-functions.sql'
            },
            'atomic_counter_update': {
                description: 'Atualiza√ß√£o at√¥mica com detec√ß√£o de conflito',
                parameters: ['p_increment', 'p_app_type'],
                source_file: 'conflict-resolution-functions.sql'
            }
        };
        
        let verificationResults = null;
        
        // Fun√ß√£o para log
        function log(message, type = 'info') {
            const logElement = document.getElementById('verification-log');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = `[${timestamp}]`;
            
            let color = '#00ff00';
            if (type === 'error') color = '#ff6b6b';
            if (type === 'warning') color = '#ffd43b';
            if (type === 'success') color = '#51cf66';
            
            logElement.innerHTML += `\n<span style="color: ${color}">${prefix} ${message}</span>`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        // Fun√ß√£o para limpar log
        function clearLog() {
            document.getElementById('verification-log').innerHTML = 'Log limpo.';
        }
        
        // Fun√ß√£o para mostrar alerta
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alerts-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = message;
            container.appendChild(alert);
            
            // Remover ap√≥s 10 segundos
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 10000);
        }
        
        // Verificar se uma tabela existe
        async function checkTableExists(tableName) {
            try {
                const { data, error } = await supabase
                    .from(tableName)
                    .select('*')
                    .limit(1);
                
                if (error) {
                    // Se o erro for "relation does not exist", a tabela n√£o existe
                    if (error.message.includes('relation') && error.message.includes('does not exist')) {
                        return false;
                    }
                    // Outros erros podem indicar que a tabela existe mas h√° problemas de acesso
                    log(`‚ö†Ô∏è Erro ao verificar tabela ${tableName}: ${error.message}`, 'warning');
                    return true; // Assumir que existe se houver erro de acesso
                }
                
                return true;
            } catch (error) {
                log(`‚ö†Ô∏è Erro ao verificar tabela ${tableName}: ${error.message}`, 'warning');
                return false;
            }
        }
        
        // Verificar se uma fun√ß√£o existe (m√©todo simplificado)
        async function checkFunctionExists(functionName) {
            try {
                // Tentar executar a fun√ß√£o com par√¢metros nulos para ver se existe
                const { data, error } = await supabase.rpc(functionName, {});
                
                if (error) {
                    // Se o erro for "function does not exist", a fun√ß√£o n√£o existe
                    if (error.message.includes('function') && error.message.includes('does not exist')) {
                        return false;
                    }
                    // Outros erros podem indicar que a fun√ß√£o existe mas h√° problemas de par√¢metros
                    return true;
                }
                
                return true;
            } catch (error) {
                return false;
            }
        }
        
        // Fun√ß√£o principal de verifica√ß√£o
        async function runVerification() {
            const btn = document.getElementById('verify-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span> Verificando...';
            btn.disabled = true;
            
            try {
                log('üöÄ Iniciando verifica√ß√£o do banco de dados Supabase...');
                log('üîó Conectando ao Supabase...');
                
                const results = {
                    tables: {},
                    functions: {},
                    summary: {
                        total_tables: Object.keys(REQUIRED_TABLES).length,
                        existing_tables: 0,
                        missing_tables: 0,
                        total_functions: Object.keys(REQUIRED_FUNCTIONS).length,
                        existing_functions: 0,
                        missing_functions: 0
                    }
                };
                
                // Verificar tabelas
                log('üìã Verificando tabelas...');
                for (const [tableName, tableInfo] of Object.entries(REQUIRED_TABLES)) {
                    log(`   Verificando: ${tableName}`);
                    
                    const exists = await checkTableExists(tableName);
                    
                    if (exists) {
                        log(`   ‚úÖ ${tableName} - OK`, 'success');
                        results.summary.existing_tables++;
                        results.tables[tableName] = {
                            exists: true,
                            description: tableInfo.description,
                            source_file: tableInfo.source_file,
                            status: 'OK'
                        };
                    } else {
                        log(`   ‚ùå ${tableName} - AUSENTE`, 'error');
                        results.summary.missing_tables++;
                        results.tables[tableName] = {
                            exists: false,
                            description: tableInfo.description,
                            source_file: tableInfo.source_file,
                            status: 'MISSING'
                        };
                    }
                }
                
                // Verificar fun√ß√µes
                log('‚öôÔ∏è Verificando fun√ß√µes...');
                for (const [functionName, functionInfo] of Object.entries(REQUIRED_FUNCTIONS)) {
                    log(`   Verificando: ${functionName}`);
                    
                    const exists = await checkFunctionExists(functionName);
                    
                    if (exists) {
                        log(`   ‚úÖ ${functionName} - OK`, 'success');
                        results.summary.existing_functions++;
                        results.functions[functionName] = {
                            exists: true,
                            description: functionInfo.description,
                            parameters: functionInfo.parameters,
                            source_file: functionInfo.source_file,
                            status: 'OK'
                        };
                    } else {
                        log(`   ‚ùå ${functionName} - AUSENTE`, 'error');
                        results.summary.missing_functions++;
                        results.functions[functionName] = {
                            exists: false,
                            description: functionInfo.description,
                            parameters: functionInfo.parameters,
                            source_file: functionInfo.source_file,
                            status: 'MISSING'
                        };
                    }
                }
                
                verificationResults = results;
                
                // Atualizar interface
                updateStatusCards(results);
                updateTablesSection(results);
                updateFunctionsSection(results);
                
                // Mostrar se√ß√µes de detalhes
                document.getElementById('tables-section').style.display = 'block';
                document.getElementById('functions-section').style.display = 'block';
                
                // Mostrar alerta de resultado
                const isComplete = results.summary.missing_tables === 0 && 
                                 results.summary.missing_functions === 0;
                
                if (isComplete) {
                    showAlert('üéâ <strong>Sistema Completo!</strong> Todas as tabelas e fun√ß√µes est√£o presentes.', 'success');
                    log('üéâ SISTEMA COMPLETO - Pronto para uso!', 'success');
                } else {
                    showAlert('‚ö†Ô∏è <strong>Sistema Incompleto.</strong> Algumas tabelas ou fun√ß√µes est√£o ausentes.', 'warning');
                    log('‚ö†Ô∏è SISTEMA INCOMPLETO - Execute os arquivos SQL necess√°rios', 'warning');
                }
                
                log('‚úÖ Verifica√ß√£o conclu√≠da!', 'success');
                
            } catch (error) {
                log(`‚ùå Erro durante verifica√ß√£o: ${error.message}`, 'error');
                showAlert(`‚ùå <strong>Erro:</strong> ${error.message}`, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }
        
        // Atualizar cards de status
        function updateStatusCards(results) {
            const { summary } = results;
            
            // Status do sistema
            const systemCard = document.getElementById('system-status-card');
            const systemStatus = document.getElementById('system-status');
            const systemText = document.getElementById('system-status-text');
            
            const isComplete = summary.missing_tables === 0 && summary.missing_functions === 0;
            
            if (isComplete) {
                systemCard.className = 'status-card complete';
                systemStatus.textContent = '‚úÖ';
                systemText.textContent = 'Sistema Completo';
            } else {
                systemCard.className = 'status-card incomplete';
                systemStatus.textContent = '‚ö†Ô∏è';
                systemText.textContent = 'Sistema Incompleto';
            }
            
            // Status das tabelas
            const tablesCard = document.getElementById('tables-status-card');
            const tablesStatus = document.getElementById('tables-status');
            
            tablesStatus.textContent = `${summary.existing_tables}/${summary.total_tables}`;
            
            if (summary.missing_tables === 0) {
                tablesCard.className = 'status-card complete';
            } else {
                tablesCard.className = 'status-card incomplete';
            }
            
            // Status das fun√ß√µes
            const functionsCard = document.getElementById('functions-status-card');
            const functionsStatus = document.getElementById('functions-status');
            
            functionsStatus.textContent = `${summary.existing_functions}/${summary.total_functions}`;
            
            if (summary.missing_functions === 0) {
                functionsCard.className = 'status-card complete';
            } else {
                functionsCard.className = 'status-card incomplete';
            }
            
            // Barra de progresso
            const totalItems = summary.total_tables + summary.total_functions;
            const existingItems = summary.existing_tables + summary.existing_functions;
            const progress = (existingItems / totalItems) * 100;
            
            document.getElementById('overall-progress').style.width = `${progress}%`;
        }
        
        // Atualizar se√ß√£o de tabelas
        function updateTablesSection(results) {
            const tablesList = document.getElementById('tables-list');
            tablesList.innerHTML = '';
            
            Object.entries(results.tables).forEach(([tableName, tableInfo]) => {
                const tableItem = document.createElement('div');
                tableItem.className = `table-item ${tableInfo.status.toLowerCase()}`;
                
                const statusIcon = tableInfo.exists ? '‚úÖ' : '‚ùå';
                
                tableItem.innerHTML = `
                    <h4>${statusIcon} ${tableName}</h4>
                    <p>${tableInfo.description}</p>
                    <div class="source">Arquivo: ${tableInfo.source_file}</div>
                `;
                
                tablesList.appendChild(tableItem);
            });
        }
        
        // Atualizar se√ß√£o de fun√ß√µes
        function updateFunctionsSection(results) {
            const functionsList = document.getElementById('functions-list');
            functionsList.innerHTML = '';
            
            Object.entries(results.functions).forEach(([functionName, functionInfo]) => {
                const functionItem = document.createElement('div');
                functionItem.className = `table-item ${functionInfo.status.toLowerCase()}`;
                
                const statusIcon = functionInfo.exists ? '‚úÖ' : '‚ùå';
                
                functionItem.innerHTML = `
                    <h4>${statusIcon} ${functionName}</h4>
                    <p>${functionInfo.description}</p>
                    <p><strong>Par√¢metros:</strong> ${functionInfo.parameters.join(', ') || 'Nenhum'}</p>
                    <div class="source">Arquivo: ${functionInfo.source_file}</div>
                `;
                
                functionsList.appendChild(functionItem);
            });
        }
        
        // Inicializa√ß√£o
        log('üîç Interface de verifica√ß√£o carregada');
        log('‚ÑπÔ∏è Clique em "Executar Verifica√ß√£o" para come√ßar');
    </script>
</body>
</html>