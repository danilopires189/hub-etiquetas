<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verifica√ß√£o de Tabelas Supabase</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: #f9f9f9;
        }
        
        .section h2 {
            color: #333;
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .status-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .status-card.complete {
            border-left: 4px solid #10b981;
        }
        
        .status-card.incomplete {
            border-left: 4px solid #f59e0b;
        }
        
        .status-card.error {
            border-left: 4px solid #ef4444;
        }
        
        .status-card h3 {
            color: #333;
            margin-bottom: 10px;
            font-size: 1em;
        }
        
        .status-card .value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .status-card.complete .value {
            color: #10b981;
        }
        
        .status-card.incomplete .value {
            color: #f59e0b;
        }
        
        .status-card.error .value {
            color: #ef4444;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
        
        .table-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .table-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .table-item.ok {
            border-left: 4px solid #10b981;
        }
        
        .table-item.missing {
            border-left: 4px solid #ef4444;
        }
        
        .table-item.issues {
            border-left: 4px solid #f59e0b;
        }
        
        .table-item h4 {
            color: #333;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .table-item p {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 8px;
        }
        
        .table-item .source {
            font-size: 0.8em;
            color: #888;
            font-style: italic;
        }
        
        .log {
            background: #1e1e1e;
            color: #00ff00;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }
        
        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fca5a5;
        }
        
        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #fcd34d;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }
        
        .details-section {
            margin-top: 20px;
        }
        
        .collapsible {
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            margin-bottom: 10px;
        }
        
        .collapsible-header {
            padding: 15px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
        }
        
        .collapsible-header:hover {
            background: #e5e7eb;
        }
        
        .collapsible-content {
            padding: 0 15px 15px;
            display: none;
        }
        
        .collapsible.open .collapsible-content {
            display: block;
        }
        
        .collapsible.open .collapsible-header::after {
            content: '‚ñº';
        }
        
        .collapsible-header::after {
            content: '‚ñ∂';
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîç Verifica√ß√£o de Tabelas Supabase</h1>
            <p>Verifique se todas as tabelas necess√°rias foram criadas no banco de dados</p>
        </div>
        
        <div class="content">
            <!-- Status Geral -->
            <div class="section">
                <h2>üìä Status Geral do Sistema</h2>
                <div class="status-overview">
                    <div class="status-card" id="system-status-card">
                        <h3>Sistema</h3>
                        <div class="value" id="system-status">-</div>
                        <p id="system-status-text">Aguardando verifica√ß√£o</p>
                    </div>
                    <div class="status-card" id="tables-status-card">
                        <h3>Tabelas</h3>
                        <div class="value" id="tables-status">-/-</div>
                        <p>Existentes / Necess√°rias</p>
                    </div>
                    <div class="status-card" id="functions-status-card">
                        <h3>Fun√ß√µes</h3>
                        <div class="value" id="functions-status">-/-</div>
                        <p>Existentes / Necess√°rias</p>
                    </div>
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="overall-progress" style="width: 0%"></div>
                </div>
                
                <button class="btn" onclick="runVerification()" id="verify-btn">
                    üîç Executar Verifica√ß√£o
                </button>
                <button class="btn btn-success" onclick="exportReport()" id="export-btn" disabled>
                    üìÑ Exportar Relat√≥rio
                </button>
            </div>
            
            <!-- Alertas -->
            <div id="alerts-container"></div>
            
            <!-- Detalhes das Tabelas -->
            <div class="section details-section" id="tables-section" style="display: none;">
                <h2>üìã Detalhes das Tabelas</h2>
                <div class="table-list" id="tables-list">
                    <!-- Ser√° preenchido dinamicamente -->
                </div>
            </div>
            
            <!-- Detalhes das Fun√ß√µes -->
            <div class="section details-section" id="functions-section" style="display: none;">
                <h2>‚öôÔ∏è Detalhes das Fun√ß√µes</h2>
                <div class="table-list" id="functions-list">
                    <!-- Ser√° preenchido dinamicamente -->
                </div>
            </div>
            
            <!-- A√ß√µes Recomendadas -->
            <div class="section details-section" id="actions-section" style="display: none;">
                <h2>üìù A√ß√µes Recomendadas</h2>
                <div id="recommended-actions">
                    <!-- Ser√° preenchido dinamicamente -->
                </div>
            </div>
            
            <!-- Log de Verifica√ß√£o -->
            <div class="section">
                <h2>üìù Log de Verifica√ß√£o</h2>
                <div class="log" id="verification-log">Aguardando verifica√ß√£o...</div>
                <button class="btn" onclick="clearLog()">üßπ Limpar Log</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        
        // Configura√ß√£o do Supabase (substitua pelos seus valores)
        const SUPABASE_URL = 'https://jomwkkhhhekbyanftpoc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImpvbXdra2hoaGVrYnlhbmZ0cG9jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzY1MjU0NzQsImV4cCI6MjA1MjEwMTQ3NH0.Ej4Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8';
        
        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let verificationResults = null;
        
        // Lista completa de tabelas necess√°rias para o sistema
        const REQUIRED_TABLES = {
            // Tabelas principais do sistema
            'labels': {
                description: 'Registro de todas as gera√ß√µes de etiquetas',
                required_columns: ['id', 'application_type', 'quantity', 'copies', 'created_at'],
                source_file: 'schema.sql'
            },
            'global_counter': {
                description: 'Contador global centralizado de etiquetas',
                required_columns: ['id', 'total_count', 'application_breakdown', 'last_updated', 'version'],
                source_file: 'schema.sql'
            },
            'user_sessions': {
                description: 'Sess√µes de usu√°rio para rastreamento',
                required_columns: ['id', 'session_id', 'created_at', 'is_active'],
                source_file: 'schema.sql'
            },
            'application_stats': {
                description: 'Estat√≠sticas agregadas por aplica√ß√£o',
                required_columns: ['id', 'application_type', 'date', 'total_generations', 'total_labels'],
                source_file: 'schema.sql'
            },
            
            // Tabela de hist√≥rico (nova funcionalidade)
            'application_history': {
                description: 'Hist√≥rico de gera√ß√µes por aplica√ß√£o (localStorage + Supabase)',
                required_columns: ['id', 'application_type', 'quantity', 'copies', 'unique_key', 'created_at'],
                source_file: 'application-history-schema.sql'
            },
            
            // Tabela de resolu√ß√£o de conflitos
            'conflict_resolution_log': {
                description: 'Log de resolu√ß√µes de conflito do sistema',
                required_columns: ['id', 'data_type', 'resolution_strategy', 'created_at'],
                source_file: 'conflict-resolution-functions.sql'
            }
        };

        // Fun√ß√µes necess√°rias no banco
        const REQUIRED_FUNCTIONS = {
            'update_global_counter': {
                description: 'Atualiza contador global de forma thread-safe',
                parameters: ['increment_amount', 'app_type'],
                source_file: 'schema.sql'
            },
            'get_counter_stats': {
                description: 'Obt√©m estat√≠sticas do contador global',
                parameters: [],
                source_file: 'schema.sql'
            },
            'register_label_generation': {
                description: 'Registra nova gera√ß√£o de etiquetas',
                parameters: ['p_application_type', 'p_quantity', 'p_copies'],
                source_file: 'schema.sql'
            },
            'migrate_global_counter': {
                description: 'Migra dados do localStorage para Supabase',
                parameters: ['p_total_count', 'p_application_breakdown'],
                source_file: 'schema.sql'
            },
            'apply_resolved_counter': {
                description: 'Aplica dados resolvidos ap√≥s conflito',
                parameters: ['p_total_count', 'p_application_breakdown'],
                source_file: 'conflict-resolution-functions.sql'
            },
            'atomic_counter_update': {
                description: 'Atualiza√ß√£o at√¥mica com detec√ß√£o de conflito',
                parameters: ['p_increment', 'p_app_type'],
                source_file: 'conflict-resolution-functions.sql'
            }
        };

        class DatabaseVerifier {
            constructor(supabaseClient) {
                this.supabase = supabaseClient;
                this.results = {
                    tables: {},
                    functions: {},
                    summary: {
                        total_tables: Object.keys(REQUIRED_TABLES).length,
                        existing_tables: 0,
                        missing_tables: 0,
                        total_functions: Object.keys(REQUIRED_FUNCTIONS).length,
                        existing_functions: 0,
                        missing_functions: 0
                    }
                };
            }
            
            /**
             * Verificar se uma tabela existe
             */
            async checkTableExists(tableName) {
                try {
                    const { data, error } = await this.supabase
                        .from('information_schema.tables')
                        .select('table_name, table_schema')
                        .eq('table_schema', 'public')
                        .eq('table_name', tableName);
                    
                    if (error) {
                        console.warn(`‚ö†Ô∏è Erro ao verificar tabela ${tableName}:`, error);
                        return false;
                    }
                    
                    return data && data.length > 0;
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Erro ao verificar tabela ${tableName}:`, error);
                    return false;
                }
            }
            
            /**
             * Verificar colunas de uma tabela
             */
            async checkTableColumns(tableName, requiredColumns) {
                try {
                    const { data, error } = await this.supabase
                        .from('information_schema.columns')
                        .select('column_name, data_type, is_nullable')
                        .eq('table_schema', 'public')
                        .eq('table_name', tableName);
                    
                    if (error) {
                        console.warn(`‚ö†Ô∏è Erro ao verificar colunas de ${tableName}:`, error);
                        return { exists: false, columns: [], missing: requiredColumns };
                    }
                    
                    const existingColumns = data.map(col => col.column_name);
                    const missingColumns = requiredColumns.filter(col => !existingColumns.includes(col));
                    
                    return {
                        exists: true,
                        columns: existingColumns,
                        missing: missingColumns,
                        details: data
                    };
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Erro ao verificar colunas de ${tableName}:`, error);
                    return { exists: false, columns: [], missing: requiredColumns };
                }
            }
            
            /**
             * Verificar se uma fun√ß√£o existe
             */
            async checkFunctionExists(functionName) {
                try {
                    const { data, error } = await this.supabase
                        .from('information_schema.routines')
                        .select('routine_name, routine_type')
                        .eq('routine_schema', 'public')
                        .eq('routine_name', functionName);
                    
                    if (error) {
                        console.warn(`‚ö†Ô∏è Erro ao verificar fun√ß√£o ${functionName}:`, error);
                        return false;
                    }
                    
                    return data && data.length > 0;
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Erro ao verificar fun√ß√£o ${functionName}:`, error);
                    return false;
                }
            }
            
            /**
             * Testar acesso b√°sico a uma tabela
             */
            async testTableAccess(tableName) {
                try {
                    const { data, error } = await this.supabase
                        .from(tableName)
                        .select('*')
                        .limit(1);
                    
                    if (error) {
                        return { accessible: false, error: error.message };
                    }
                    
                    return { accessible: true, sample_count: data ? data.length : 0 };
                } catch (error) {
                    return { accessible: false, error: error.message };
                }
            }
            
            /**
             * Verificar todas as tabelas
             */
            async verifyAllTables() {
                log('üîç Verificando tabelas do banco de dados...');
                
                for (const [tableName, tableInfo] of Object.entries(REQUIRED_TABLES)) {
                    log(`üìã Verificando tabela: ${tableName}`);
                    
                    // Verificar se existe
                    const exists = await this.checkTableExists(tableName);
                    
                    if (exists) {
                        log(`‚úÖ Tabela ${tableName} existe`, 'success');
                        this.results.summary.existing_tables++;
                        
                        // Verificar colunas
                        const columnCheck = await this.checkTableColumns(tableName, tableInfo.required_columns);
                        
                        // Testar acesso
                        const accessTest = await this.testTableAccess(tableName);
                        
                        this.results.tables[tableName] = {
                            exists: true,
                            description: tableInfo.description,
                            source_file: tableInfo.source_file,
                            columns: columnCheck,
                            access: accessTest,
                            status: columnCheck.missing.length === 0 && accessTest.accessible ? 'OK' : 'ISSUES'
                        };
                        
                        if (columnCheck.missing.length > 0) {
                            log(`‚ö†Ô∏è Colunas ausentes em ${tableName}: ${columnCheck.missing.join(', ')}`, 'warning');
                        }
                        
                        if (!accessTest.accessible) {
                            log(`‚ùå Erro de acesso √† tabela ${tableName}: ${accessTest.error}`, 'error');
                        }
                        
                    } else {
                        log(`‚ùå Tabela ${tableName} N√ÉO existe`, 'error');
                        this.results.summary.missing_tables++;
                        
                        this.results.tables[tableName] = {
                            exists: false,
                            description: tableInfo.description,
                            source_file: tableInfo.source_file,
                            status: 'MISSING'
                        };
                    }
                }
            }
            
            /**
             * Verificar todas as fun√ß√µes
             */
            async verifyAllFunctions() {
                log('üîß Verificando fun√ß√µes do banco de dados...');
                
                for (const [functionName, functionInfo] of Object.entries(REQUIRED_FUNCTIONS)) {
                    log(`‚öôÔ∏è Verificando fun√ß√£o: ${functionName}`);
                    
                    const exists = await this.checkFunctionExists(functionName);
                    
                    if (exists) {
                        log(`‚úÖ Fun√ß√£o ${functionName} existe`, 'success');
                        this.results.summary.existing_functions++;
                        
                        this.results.functions[functionName] = {
                            exists: true,
                            description: functionInfo.description,
                            parameters: functionInfo.parameters,
                            source_file: functionInfo.source_file,
                            status: 'OK'
                        };
                    } else {
                        log(`‚ùå Fun√ß√£o ${functionName} N√ÉO existe`, 'error');
                        this.results.summary.missing_functions++;
                        
                        this.results.functions[functionName] = {
                            exists: false,
                            description: functionInfo.description,
                            parameters: functionInfo.parameters,
                            source_file: functionInfo.source_file,
                            status: 'MISSING'
                        };
                    }
                }
            }
            
            /**
             * Executar verifica√ß√£o completa
             */
            async runCompleteVerification() {
                log('üöÄ Iniciando verifica√ß√£o completa do banco de dados Supabase...');
                
                const startTime = Date.now();
                
                try {
                    // Verificar tabelas
                    await this.verifyAllTables();
                    
                    // Verificar fun√ß√µes
                    await this.verifyAllFunctions();
                    
                    const endTime = Date.now();
                    log(`‚è±Ô∏è Verifica√ß√£o conclu√≠da em ${endTime - startTime}ms`, 'success');
                    
                    return this.results;
                    
                } catch (error) {
                    log(`‚ùå Erro durante verifica√ß√£o: ${error.message}`, 'error');
                    throw error;
                }
            }
        }
        
        // Fun√ß√£o para log
        function log(message, type = 'info') {
            const logElement = document.getElementById('verification-log');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = `[${timestamp}]`;
            
            let color = '#00ff00';
            if (type === 'error') color = '#ff6b6b';
            if (type === 'warning') color = '#ffd43b';
            if (type === 'success') color = '#51cf66';
            
            logElement.innerHTML += `\n<span style="color: ${color}">${prefix} ${message}</span>`;
            logElement.scrollTop = logElement.scrollHeight;
        }
        
        // Fun√ß√£o para limpar log
        window.clearLog = function() {
            document.getElementById('verification-log').innerHTML = 'Log limpo.';
        };
        
        // Fun√ß√£o para mostrar alerta
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alerts-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.innerHTML = message;
            container.appendChild(alert);
            
            // Remover ap√≥s 10 segundos
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.parentNode.removeChild(alert);
                }
            }, 10000);
        }
        
        // Fun√ß√£o principal de verifica√ß√£o
        window.runVerification = async function() {
            const btn = document.getElementById('verify-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<span class="loading"></span> Verificando...';
            btn.disabled = true;
            
            try {
                log('üöÄ Iniciando verifica√ß√£o completa do banco de dados...');
                
                // Criar verificador diretamente (sem import)
                const verifier = new DatabaseVerifier(supabase);
                
                // Executar verifica√ß√£o
                verificationResults = await verifier.runCompleteVerification();
                
                // Atualizar interface
                updateStatusCards(verificationResults);
                updateTablesSection(verificationResults);
                updateFunctionsSection(verificationResults);
                updateActionsSection(verificationResults);
                
                // Mostrar se√ß√µes de detalhes
                document.getElementById('tables-section').style.display = 'block';
                document.getElementById('functions-section').style.display = 'block';
                document.getElementById('actions-section').style.display = 'block';
                
                // Habilitar exporta√ß√£o
                document.getElementById('export-btn').disabled = false;
                
                // Mostrar alerta de resultado
                const isComplete = verificationResults.summary.missing_tables === 0 && 
                                 verificationResults.summary.missing_functions === 0;
                
                if (isComplete) {
                    showAlert('üéâ <strong>Sistema Completo!</strong> Todas as tabelas e fun√ß√µes est√£o presentes.', 'success');
                } else {
                    showAlert('‚ö†Ô∏è <strong>Sistema Incompleto.</strong> Algumas tabelas ou fun√ß√µes est√£o ausentes. Verifique as a√ß√µes recomendadas.', 'warning');
                }
                
                log('‚úÖ Verifica√ß√£o conclu√≠da com sucesso!', 'success');
                
            } catch (error) {
                log(`‚ùå Erro durante verifica√ß√£o: ${error.message}`, 'error');
                showAlert(`‚ùå <strong>Erro:</strong> ${error.message}`, 'error');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };
        
        // Atualizar cards de status
        function updateStatusCards(results) {
            const { summary } = results;
            
            // Status do sistema
            const systemCard = document.getElementById('system-status-card');
            const systemStatus = document.getElementById('system-status');
            const systemText = document.getElementById('system-status-text');
            
            const isComplete = summary.missing_tables === 0 && summary.missing_functions === 0;
            
            if (isComplete) {
                systemCard.className = 'status-card complete';
                systemStatus.textContent = '‚úÖ';
                systemText.textContent = 'Sistema Completo';
            } else {
                systemCard.className = 'status-card incomplete';
                systemStatus.textContent = '‚ö†Ô∏è';
                systemText.textContent = 'Sistema Incompleto';
            }
            
            // Status das tabelas
            const tablesCard = document.getElementById('tables-status-card');
            const tablesStatus = document.getElementById('tables-status');
            
            tablesStatus.textContent = `${summary.existing_tables}/${summary.total_tables}`;
            
            if (summary.missing_tables === 0) {
                tablesCard.className = 'status-card complete';
            } else {
                tablesCard.className = 'status-card incomplete';
            }
            
            // Status das fun√ß√µes
            const functionsCard = document.getElementById('functions-status-card');
            const functionsStatus = document.getElementById('functions-status');
            
            functionsStatus.textContent = `${summary.existing_functions}/${summary.total_functions}`;
            
            if (summary.missing_functions === 0) {
                functionsCard.className = 'status-card complete';
            } else {
                functionsCard.className = 'status-card incomplete';
            }
            
            // Barra de progresso
            const totalItems = summary.total_tables + summary.total_functions;
            const existingItems = summary.existing_tables + summary.existing_functions;
            const progress = (existingItems / totalItems) * 100;
            
            document.getElementById('overall-progress').style.width = `${progress}%`;
        }
        
        // Atualizar se√ß√£o de tabelas
        function updateTablesSection(results) {
            const tablesList = document.getElementById('tables-list');
            tablesList.innerHTML = '';
            
            Object.entries(results.tables).forEach(([tableName, tableInfo]) => {
                const tableItem = document.createElement('div');
                tableItem.className = `table-item ${tableInfo.status.toLowerCase()}`;
                
                let statusIcon = '‚ùå';
                if (tableInfo.status === 'OK') statusIcon = '‚úÖ';
                if (tableInfo.status === 'ISSUES') statusIcon = '‚ö†Ô∏è';
                
                let details = '';
                if (tableInfo.exists && tableInfo.columns) {
                    const missingCols = tableInfo.columns.missing.length;
                    if (missingCols > 0) {
                        details += `<p><strong>Colunas ausentes:</strong> ${tableInfo.columns.missing.join(', ')}</p>`;
                    }
                    if (!tableInfo.access.accessible) {
                        details += `<p><strong>Erro de acesso:</strong> ${tableInfo.access.error}</p>`;
                    }
                }
                
                tableItem.innerHTML = `
                    <h4>${statusIcon} ${tableName}</h4>
                    <p>${tableInfo.description}</p>
                    ${details}
                    <div class="source">Arquivo: ${tableInfo.source_file}</div>
                `;
                
                tablesList.appendChild(tableItem);
            });
        }
        
        // Atualizar se√ß√£o de fun√ß√µes
        function updateFunctionsSection(results) {
            const functionsList = document.getElementById('functions-list');
            functionsList.innerHTML = '';
            
            Object.entries(results.functions).forEach(([functionName, functionInfo]) => {
                const functionItem = document.createElement('div');
                functionItem.className = `table-item ${functionInfo.status.toLowerCase()}`;
                
                const statusIcon = functionInfo.exists ? '‚úÖ' : '‚ùå';
                
                functionItem.innerHTML = `
                    <h4>${statusIcon} ${functionName}</h4>
                    <p>${functionInfo.description}</p>
                    <p><strong>Par√¢metros:</strong> ${functionInfo.parameters.join(', ') || 'Nenhum'}</p>
                    <div class="source">Arquivo: ${functionInfo.source_file}</div>
                `;
                
                functionsList.appendChild(functionItem);
            });
        }
        
        // Atualizar se√ß√£o de a√ß√µes
        function updateActionsSection(results) {
            const actionsContainer = document.getElementById('recommended-actions');
            const { summary } = results;
            
            let actionsHTML = '';
            
            if (summary.missing_tables === 0 && summary.missing_functions === 0) {
                actionsHTML = `
                    <div class="alert alert-success">
                        üéâ <strong>Parab√©ns!</strong> Todas as tabelas e fun√ß√µes necess√°rias est√£o presentes no banco de dados.
                        O sistema est√° pronto para uso!
                    </div>
                `;
            } else {
                actionsHTML = '<div class="alert alert-warning"><strong>A√ß√µes necess√°rias:</strong></div>';
                
                if (summary.missing_tables > 0) {
                    actionsHTML += `
                        <div class="collapsible">
                            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                üìã Tabelas Ausentes (${summary.missing_tables})
                            </div>
                            <div class="collapsible-content">
                                <ol>
                    `;
                    
                    Object.entries(results.tables).forEach(([tableName, tableInfo]) => {
                        if (!tableInfo.exists) {
                            actionsHTML += `
                                <li>
                                    <strong>${tableName}</strong><br>
                                    Execute o arquivo: <code>${tableInfo.source_file}</code><br>
                                    <small>${tableInfo.description}</small>
                                </li>
                            `;
                        }
                    });
                    
                    actionsHTML += `
                                </ol>
                            </div>
                        </div>
                    `;
                }
                
                if (summary.missing_functions > 0) {
                    actionsHTML += `
                        <div class="collapsible">
                            <div class="collapsible-header" onclick="toggleCollapsible(this)">
                                ‚öôÔ∏è Fun√ß√µes Ausentes (${summary.missing_functions})
                            </div>
                            <div class="collapsible-content">
                                <ol>
                    `;
                    
                    Object.entries(results.functions).forEach(([functionName, functionInfo]) => {
                        if (!functionInfo.exists) {
                            actionsHTML += `
                                <li>
                                    <strong>${functionName}</strong><br>
                                    Execute o arquivo: <code>${functionInfo.source_file}</code><br>
                                    <small>${functionInfo.description}</small>
                                </li>
                            `;
                        }
                    });
                    
                    actionsHTML += `
                                </ol>
                            </div>
                        </div>
                    `;
                }
                
                actionsHTML += `
                    <div style="margin-top: 20px;">
                        <h4>üìù Como executar:</h4>
                        <ol>
                            <li>Acesse o painel do Supabase: <a href="https://supabase.com/dashboard" target="_blank">https://supabase.com/dashboard</a></li>
                            <li>V√° para o SQL Editor do seu projeto</li>
                            <li>Copie e execute o conte√∫do dos arquivos SQL listados acima</li>
                            <li>Execute esta verifica√ß√£o novamente</li>
                        </ol>
                    </div>
                `;
            }
            
            actionsContainer.innerHTML = actionsHTML;
        }
        
        // Toggle collapsible
        window.toggleCollapsible = function(header) {
            const collapsible = header.parentElement;
            collapsible.classList.toggle('open');
        };
        
        // Exportar relat√≥rio
        window.exportReport = function() {
            if (!verificationResults) {
                showAlert('‚ùå Execute a verifica√ß√£o primeiro!', 'error');
                return;
            }
            
            const report = {
                timestamp: new Date().toISOString(),
                system_status: verificationResults.summary.missing_tables === 0 && 
                              verificationResults.summary.missing_functions === 0 ? 'COMPLETE' : 'INCOMPLETE',
                ...verificationResults
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `supabase-verification-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showAlert('üìÑ Relat√≥rio exportado com sucesso!', 'success');
        };
        
        // Inicializa√ß√£o
        log('üîç Interface de verifica√ß√£o carregada');
        log('‚ÑπÔ∏è Clique em "Executar Verifica√ß√£o" para come√ßar');
    </script>
</body>
</html>