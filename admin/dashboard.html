<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Hub de Etiquetas</title>
    <link rel="icon" href="../assets/pm.png" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="../shared/design-system.css">
    <style>
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: #f8fafc;
            margin: 0;
            padding: 0;
            color: #1f2937;
        }

        .dashboard-header {
            background: white;
            border-bottom: 1px solid #e5e7eb;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .header-logo {
            width: 40px;
            height: 40px;
            border-radius: 8px;
        }

        .header-title {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
            margin: 0;
        }

        .header-subtitle {
            font-size: 14px;
            color: #6b7280;
            margin: 0;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .dashboard-content {
            padding: 24px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .stat-title {
            font-size: 14px;
            font-weight: 500;
            color: #6b7280;
            margin: 0;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: #1f2937;
            margin: 0 0 8px 0;
        }

        .stat-change {
            font-size: 14px;
            font-weight: 500;
        }

        .stat-change.positive {
            color: #059669;
        }

        .stat-change.negative {
            color: #dc2626;
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            margin-bottom: 30px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }

        .chart-filters {
            display: flex;
            gap: 8px;
        }

        .filter-btn {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            background: white;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .filter-btn.active {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }

        .recent-activity {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .activity-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .activity-title {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin: 0;
        }

        .activity-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .activity-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            background: #f9fafb;
        }

        .activity-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            font-size: 14px;
            color: #374151;
            margin: 0 0 4px 0;
        }

        .activity-time {
            font-size: 12px;
            color: #6b7280;
            margin: 0;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #6b7280;
        }

        .loading-spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-state {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #6b7280;
        }

        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #10b981;
        }

        .sync-indicator.offline {
            background: #f59e0b;
        }

        .sync-indicator.error {
            background: #ef4444;
        }

        .reports-container {
            margin-top: 20px;
        }

        .report-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .filter-group label {
            font-size: 14px;
            font-weight: 500;
            color: #374151;
        }

        .form-input {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .report-results {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .report-summary, .usage-patterns, .export-options {
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .report-summary h3, .usage-patterns h3, .export-options h3 {
            margin: 0 0 16px 0;
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .summary-stat {
            background: white;
            padding: 16px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        .summary-stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .summary-stat-value {
            font-size: 20px;
            font-weight: 700;
            color: #1f2937;
        }

        .patterns-content {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .pattern-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: white;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        .pattern-label {
            font-size: 14px;
            color: #374151;
        }

        .pattern-value {
            font-size: 14px;
            font-weight: 600;
            color: #1f2937;
        }

        .export-buttons {
            display: flex;
            gap: 12px;
        }

        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }

            .header-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .dashboard-content {
                padding: 16px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .chart-header {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }

            .report-filters {
                grid-template-columns: 1fr;
            }

            .export-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="header-left">
            <img src="../assets/pm.png" alt="Pague Menos" class="header-logo" onerror="this.style.display='none'">
            <div>
                <h1 class="header-title">Dashboard Administrativo</h1>
                <p class="header-subtitle">Hub de Etiquetas</p>
            </div>
        </div>
        
        <div class="header-actions">
            <div class="sync-status" id="syncStatus">
                <div class="sync-indicator" id="syncIndicator"></div>
                <span id="syncText">Conectado</span>
            </div>
            <a href="../index.html" class="btn btn-secondary">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <polyline points="9,22 9,12 15,12 15,22"/>
                </svg>
                Hub
            </a>
            <button class="btn btn-danger" id="logoutBtn">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                    <polyline points="16,17 21,12 16,7"/>
                    <path d="M21 12H9"/>
                </svg>
                Sair
            </button>
        </div>
    </div>

    <div class="dashboard-content">
        <!-- Estat√≠sticas Principais -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-header">
                    <h3 class="stat-title">Total de Etiquetas</h3>
                    <div class="stat-icon" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                        üìä
                    </div>
                </div>
                <p class="stat-value" id="totalLabels">-</p>
                <p class="stat-change positive" id="totalChange">Carregando...</p>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <h3 class="stat-title">Hoje</h3>
                    <div class="stat-icon" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
                        üìÖ
                    </div>
                </div>
                <p class="stat-value" id="todayLabels">-</p>
                <p class="stat-change" id="todayChange">Carregando...</p>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <h3 class="stat-title">Esta Semana</h3>
                    <div class="stat-icon" style="background: rgba(245, 158, 11, 0.1); color: #f59e0b;">
                        üìà
                    </div>
                </div>
                <p class="stat-value" id="weekLabels">-</p>
                <p class="stat-change" id="weekChange">Carregando...</p>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <h3 class="stat-title">Aplica√ß√£o Mais Usada</h3>
                    <div class="stat-icon" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6;">
                        üèÜ
                    </div>
                </div>
                <p class="stat-value" id="topApp">-</p>
                <p class="stat-change" id="topAppCount">Carregando...</p>
            </div>
        </div>

        <!-- Gr√°fico de Atividade -->
        <div class="chart-container">
            <div class="chart-header">
                <h2 class="chart-title">Atividade de Gera√ß√£o</h2>
                <div class="chart-filters">
                    <button class="filter-btn active" data-period="7d">7 dias</button>
                    <button class="filter-btn" data-period="30d">30 dias</button>
                    <button class="filter-btn" data-period="90d">90 dias</button>
                </div>
            </div>
            <div id="chartContainer">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    Carregando gr√°fico...
                </div>
            </div>
        </div>

        <!-- Relat√≥rios -->
        <div class="chart-container">
            <div class="chart-header">
                <h2 class="chart-title">Relat√≥rios e An√°lises</h2>
                <div class="chart-filters">
                    <button class="btn btn-primary" id="generateReportBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                            <polyline points="14,2 14,8 20,8"/>
                            <line x1="16" y1="13" x2="8" y2="13"/>
                            <line x1="16" y1="17" x2="8" y2="17"/>
                            <polyline points="10,9 9,9 8,9"/>
                        </svg>
                        Gerar Relat√≥rio
                    </button>
                </div>
            </div>
            
            <div class="reports-container" id="reportsContainer">
                <div class="report-filters">
                    <div class="filter-group">
                        <label for="reportStartDate">Data Inicial:</label>
                        <input type="date" id="reportStartDate" class="form-input">
                    </div>
                    <div class="filter-group">
                        <label for="reportEndDate">Data Final:</label>
                        <input type="date" id="reportEndDate" class="form-input">
                    </div>
                    <div class="filter-group">
                        <label for="reportApplication">Aplica√ß√£o:</label>
                        <select id="reportApplication" class="form-input">
                            <option value="">Todas as aplica√ß√µes</option>
                            <option value="placas">Etiquetas de Produto</option>
                            <option value="caixa">Etiquetas de Caixa</option>
                            <option value="avulso">Volume Avulso</option>
                            <option value="enderec">Endere√ßamento</option>
                            <option value="transfer">Transfer√™ncia</option>
                            <option value="termo">Termol√°beis</option>
                            <option value="pedido-direto">Pedido Direto</option>
                            <option value="etiqueta-mercadoria">Etiqueta de Mercadoria</option>
                            <option value="inventario">Invent√°rio</option>
                        </select>
                    </div>
                </div>
                
                <div class="report-results" id="reportResults" style="display: none;">
                    <div class="report-summary">
                        <h3>Resumo do Per√≠odo</h3>
                        <div class="summary-stats" id="summaryStats"></div>
                    </div>
                    
                    <div class="usage-patterns">
                        <h3>Padr√µes de Uso</h3>
                        <div class="patterns-content" id="patternsContent"></div>
                    </div>
                    
                    <div class="export-options">
                        <h3>Exportar Dados</h3>
                        <div class="export-buttons">
                            <button class="btn btn-secondary" id="exportCsvBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14,2 14,8 20,8"/>
                                </svg>
                                Exportar CSV
                            </button>
                            <button class="btn btn-secondary" id="exportJsonBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14,2 14,8 20,8"/>
                                </svg>
                                Exportar JSON
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Atividade Recente -->
        <div class="recent-activity">
            <div class="activity-header">
                <h2 class="activity-title">Atividade Recente</h2>
                <button class="btn btn-secondary" id="refreshBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23,4 23,10 17,10"/>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
                    </svg>
                    Atualizar
                </button>
            </div>
            <div class="activity-list" id="activityList">
                <div class="loading">
                    <div class="loading-spinner"></div>
                    Carregando atividades...
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import supabaseManager from '../supabase/client.js';
        import authManager from '../supabase/auth.js';
        import reportAnalyzer from '../supabase/report-analyzer.js';

        class AdminDashboard {
            constructor() {
                this.isLoading = false;
                this.currentPeriod = '7d';
                this.refreshInterval = null;
                this.currentReportData = null; // Store current report data for export
                
                this.init();
            }

            async init() {
                // Inicializar sistemas
                await this.initializeSystems();
                
                // Verificar autentica√ß√£o
                await this.checkAuthentication();
                
                // Configurar event listeners
                this.setupEventListeners();
                
                // Carregar dados iniciais
                await this.loadDashboardData();
                
                // Configurar atualiza√ß√£o autom√°tica
                this.startAutoRefresh();
            }

            async initializeSystems() {
                try {
                    await supabaseManager.initialize();
                    await authManager.initialize();
                    console.log('‚úÖ Sistemas inicializados');
                } catch (error) {
                    console.error('‚ùå Erro na inicializa√ß√£o dos sistemas:', error);
                }
            }

            async checkAuthentication() {
                try {
                    const isAuth = await authManager.isAuthenticated();
                    
                    if (!isAuth) {
                        console.log('‚ùå N√£o autenticado, redirecionando...');
                        window.location.href = './login.html';
                        return;
                    }
                    
                    // Mostrar informa√ß√µes da sess√£o
                    const sessionInfo = authManager.getSessionInfo();
                    if (sessionInfo) {
                        console.log(`‚úÖ Usu√°rio autenticado. Sess√£o expira em: ${sessionInfo.timeRemainingFormatted}`);
                        
                        // Atualizar status de sincroniza√ß√£o com info da sess√£o
                        this.updateSyncStatus('online', `Conectado (${sessionInfo.timeRemainingFormatted})`);
                    }
                } catch (error) {
                    console.error('‚ùå Erro na verifica√ß√£o de autentica√ß√£o:', error);
                    window.location.href = './login.html';
                }
            }

            setupEventListeners() {
                // Logout
                document.getElementById('logoutBtn').addEventListener('click', async () => {
                    try {
                        this.updateSyncStatus('loading', 'Fazendo logout...');
                        await authManager.logout();
                        // O authManager j√° redireciona para login.html
                    } catch (error) {
                        console.error('‚ùå Erro no logout:', error);
                        this.updateSyncStatus('error', 'Erro no logout');
                    }
                });

                // Refresh
                document.getElementById('refreshBtn').addEventListener('click', () => {
                    this.loadDashboardData();
                });

                // Filtros de per√≠odo
                document.querySelectorAll('.filter-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        this.currentPeriod = e.target.dataset.period;
                        this.loadChartData();
                    });
                });

                // Relat√≥rios
                document.getElementById('generateReportBtn').addEventListener('click', () => {
                    this.generateReport();
                });

                document.getElementById('exportCsvBtn').addEventListener('click', () => {
                    this.exportReport('csv');
                });

                document.getElementById('exportJsonBtn').addEventListener('click', () => {
                    this.exportReport('json');
                });

                // Configurar datas padr√£o para relat√≥rios
                this.setupDefaultReportDates();

                // Verificar autentica√ß√£o periodicamente
                setInterval(async () => {
                    const isAuth = await authManager.isAuthenticated();
                    if (!isAuth) {
                        console.log('‚è∞ Sess√£o expirada durante uso, redirecionando...');
                        window.location.href = './login.html';
                    }
                }, 60000); // Verificar a cada minuto
            }

            async loadDashboardData() {
                if (this.isLoading) return;
                
                this.isLoading = true;
                
                // Verificar autentica√ß√£o antes de carregar dados
                const isAuth = await authManager.isAuthenticated();
                if (!isAuth) {
                    window.location.href = './login.html';
                    return;
                }
                
                this.updateSyncStatus('loading', 'Carregando...');

                try {
                    // Carregar estat√≠sticas principais
                    await this.loadMainStats();
                    
                    // Carregar gr√°fico
                    await this.loadChartData();
                    
                    // Carregar atividade recente
                    await this.loadRecentActivity();
                    
                    // Atualizar status com informa√ß√µes da sess√£o
                    const sessionInfo = authManager.getSessionInfo();
                    if (sessionInfo) {
                        this.updateSyncStatus('online', `Conectado (${sessionInfo.timeRemainingFormatted})`);
                    } else {
                        this.updateSyncStatus('online', 'Conectado');
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao carregar dashboard:', error);
                    this.updateSyncStatus('error', 'Erro na conex√£o');
                } finally {
                    this.isLoading = false;
                }
            }

            async loadMainStats() {
                try {
                    // Obter estat√≠sticas do contador
                    const counterStats = await supabaseManager.getCounterStats();
                    
                    // Obter estat√≠sticas detalhadas
                    const now = new Date();
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    const weekAgo = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                    
                    const todayStats = await supabaseManager.getStatistics({
                        startDate: today.toISOString()
                    });
                    
                    const weekStats = await supabaseManager.getStatistics({
                        startDate: weekAgo.toISOString()
                    });

                    // Atualizar UI
                    document.getElementById('totalLabels').textContent = 
                        counterStats.total_count.toLocaleString('pt-BR');
                    document.getElementById('totalChange').textContent = 
                        `√öltima atualiza√ß√£o: ${new Date(counterStats.last_updated).toLocaleString('pt-BR')}`;

                    document.getElementById('todayLabels').textContent = 
                        todayStats.totalLabels.toLocaleString('pt-BR');
                    document.getElementById('todayChange').textContent = 
                        'Etiquetas geradas hoje';

                    document.getElementById('weekLabels').textContent = 
                        weekStats.totalLabels.toLocaleString('pt-BR');
                    document.getElementById('weekChange').textContent = 
                        '√öltimos 7 dias';

                    // Aplica√ß√£o mais usada
                    const breakdown = counterStats.application_breakdown || {};
                    const topApp = Object.entries(breakdown)
                        .sort(([,a], [,b]) => b - a)[0];
                    
                    if (topApp) {
                        const appNames = {
                            'placas': 'Etiquetas de Produto',
                            'caixa': 'Etiquetas de Caixa',
                            'avulso': 'Volume Avulso',
                            'enderec': 'Endere√ßamento',
                            'transfer': 'Transfer√™ncia',
                            'termo': 'Termol√°beis',
                            'pedido-direto': 'Pedido Direto',
                            'etiqueta-mercadoria': 'Etiqueta de Mercadoria',
                            'inventario': 'Invent√°rio'
                        };
                        
                        document.getElementById('topApp').textContent = 
                            appNames[topApp[0]] || topApp[0];
                        document.getElementById('topAppCount').textContent = 
                            `${topApp[1].toLocaleString('pt-BR')} etiquetas`;
                    }

                } catch (error) {
                    console.error('Erro ao carregar estat√≠sticas principais:', error);
                }
            }

            async loadChartData() {
                const chartContainer = document.getElementById('chartContainer');
                chartContainer.innerHTML = '<div class="loading"><div class="loading-spinner"></div>Carregando gr√°fico...</div>';

                try {
                    // Calcular per√≠odo
                    const days = parseInt(this.currentPeriod.replace('d', ''));
                    const startDate = new Date();
                    startDate.setDate(startDate.getDate() - days);

                    const stats = await supabaseManager.getStatistics({
                        startDate: startDate.toISOString()
                    });

                    // Criar gr√°fico simples com CSS
                    this.renderSimpleChart(stats.timeSeriesData, chartContainer);

                } catch (error) {
                    console.error('Erro ao carregar gr√°fico:', error);
                    chartContainer.innerHTML = '<div class="error-state"><div class="error-icon">üìä</div><p>Erro ao carregar gr√°fico</p></div>';
                }
            }

            renderSimpleChart(data, container) {
                if (!data || data.length === 0) {
                    container.innerHTML = '<div class="error-state"><div class="error-icon">üìà</div><p>Nenhum dado dispon√≠vel</p></div>';
                    return;
                }

                // Ordenar dados por data
                const sortedData = data.sort((a, b) => new Date(a.date) - new Date(b.date));
                const maxValue = Math.max(...sortedData.map(d => d.count));

                let chartHTML = '<div style="display: flex; align-items: end; gap: 4px; height: 200px; padding: 20px;">';
                
                sortedData.forEach((point, index) => {
                    const height = maxValue > 0 ? (point.count / maxValue) * 160 : 0;
                    const date = new Date(point.date).toLocaleDateString('pt-BR', { 
                        day: '2-digit', 
                        month: '2-digit' 
                    });
                    
                    chartHTML += `
                        <div style="
                            flex: 1;
                            display: flex;
                            flex-direction: column;
                            align-items: center;
                            gap: 8px;
                        ">
                            <div style="
                                background: linear-gradient(to top, #3b82f6, #60a5fa);
                                width: 100%;
                                height: ${height}px;
                                border-radius: 4px 4px 0 0;
                                min-height: 2px;
                                position: relative;
                                cursor: pointer;
                                transition: all 0.2s ease;
                            " 
                            title="${point.count} etiquetas em ${date}"
                            onmouseover="this.style.background='linear-gradient(to top, #2563eb, #3b82f6)'"
                            onmouseout="this.style.background='linear-gradient(to top, #3b82f6, #60a5fa)'">
                            </div>
                            <span style="font-size: 10px; color: #6b7280; text-align: center;">${date}</span>
                        </div>
                    `;
                });
                
                chartHTML += '</div>';
                container.innerHTML = chartHTML;
            }

            async loadRecentActivity() {
                const activityList = document.getElementById('activityList');
                
                try {
                    // Obter atividades recentes (√∫ltimas 24 horas)
                    const yesterday = new Date();
                    yesterday.setDate(yesterday.getDate() - 1);
                    
                    const stats = await supabaseManager.getStatistics({
                        startDate: yesterday.toISOString()
                    });

                    // Simular atividades recentes baseadas nos dados
                    const activities = this.generateRecentActivities(stats);
                    
                    if (activities.length === 0) {
                        activityList.innerHTML = '<div class="error-state"><div class="error-icon">üìù</div><p>Nenhuma atividade recente</p></div>';
                        return;
                    }

                    let activitiesHTML = '';
                    activities.forEach(activity => {
                        activitiesHTML += `
                            <div class="activity-item">
                                <div class="activity-icon" style="background: ${activity.color};">
                                    ${activity.icon}
                                </div>
                                <div class="activity-content">
                                    <p class="activity-text">${activity.text}</p>
                                    <p class="activity-time">${activity.time}</p>
                                </div>
                            </div>
                        `;
                    });

                    activityList.innerHTML = activitiesHTML;

                } catch (error) {
                    console.error('Erro ao carregar atividade recente:', error);
                    activityList.innerHTML = '<div class="error-state"><div class="error-icon">‚ùå</div><p>Erro ao carregar atividades</p></div>';
                }
            }

            generateRecentActivities(stats) {
                const activities = [];
                const appNames = {
                    'placas': 'Etiquetas de Produto',
                    'caixa': 'Etiquetas de Caixa',
                    'avulso': 'Volume Avulso',
                    'enderec': 'Endere√ßamento',
                    'transfer': 'Transfer√™ncia',
                    'termo': 'Termol√°beis',
                    'pedido-direto': 'Pedido Direto',
                    'etiqueta-mercadoria': 'Etiqueta de Mercadoria',
                    'inventario': 'Invent√°rio'
                };

                const appIcons = {
                    'placas': 'üè∑Ô∏è',
                    'caixa': 'üì¶',
                    'avulso': 'üìã',
                    'enderec': 'üó∫Ô∏è',
                    'transfer': 'üöö',
                    'termo': 'üå°Ô∏è',
                    'pedido-direto': '‚û°Ô∏è',
                    'etiqueta-mercadoria': 'üè™',
                    'inventario': 'üìä'
                };

                // Gerar atividades baseadas no breakdown
                Object.entries(stats.applicationBreakdown).forEach(([app, count]) => {
                    if (count > 0) {
                        activities.push({
                            icon: appIcons[app] || 'üìÑ',
                            color: 'rgba(59, 130, 246, 0.1)',
                            text: `${count.toLocaleString('pt-BR')} etiquetas geradas em ${appNames[app] || app}`,
                            time: '√öltimas 24 horas'
                        });
                    }
                });

                // Adicionar atividade de sistema
                if (stats.totalLabels > 0) {
                    activities.unshift({
                        icon: 'üîÑ',
                        color: 'rgba(16, 185, 129, 0.1)',
                        text: `Sistema sincronizado - ${stats.totalLabels.toLocaleString('pt-BR')} etiquetas processadas`,
                        time: 'Agora'
                    });
                }

                return activities.slice(0, 5); // M√°ximo 5 atividades
            }

            updateSyncStatus(status, text) {
                const indicator = document.getElementById('syncIndicator');
                const statusText = document.getElementById('syncText');
                
                indicator.className = 'sync-indicator';
                
                switch (status) {
                    case 'online':
                        indicator.classList.add('online');
                        break;
                    case 'offline':
                        indicator.classList.add('offline');
                        break;
                    case 'error':
                        indicator.classList.add('error');
                        break;
                    case 'loading':
                        indicator.style.background = '#6b7280';
                        break;
                }
                
                statusText.textContent = text;
            }

            startAutoRefresh() {
                // Atualizar a cada 30 segundos
                this.refreshInterval = setInterval(() => {
                    if (!this.isLoading) {
                        this.loadMainStats();
                    }
                }, 30000);

                // Atualizar quando a aba voltar ao foco
                document.addEventListener('visibilitychange', () => {
                    if (!document.hidden && !this.isLoading) {
                        this.loadDashboardData();
                    }
                });
            }

            /**
             * Gerar relat√≥rio baseado nos filtros selecionados
             * Requirements: 6.1, 6.2, 6.3, 6.4
             */
            async generateReport() {
                const startDate = document.getElementById('reportStartDate').value;
                const endDate = document.getElementById('reportEndDate').value;
                const application = document.getElementById('reportApplication').value;
                const reportResults = document.getElementById('reportResults');
                
                // Validar datas
                if (!startDate || !endDate) {
                    alert('Por favor, selecione as datas inicial e final para o relat√≥rio.');
                    return;
                }
                
                if (new Date(startDate) > new Date(endDate)) {
                    alert('A data inicial deve ser anterior √† data final.');
                    return;
                }

                try {
                    // Mostrar loading
                    reportResults.style.display = 'block';
                    document.getElementById('summaryStats').innerHTML = '<div class="loading"><div class="loading-spinner"></div>Gerando relat√≥rio...</div>';
                    document.getElementById('patternsContent').innerHTML = '<div class="loading"><div class="loading-spinner"></div>Analisando padr√µes...</div>';

                    // Obter dados do per√≠odo
                    const filters = {
                        startDate: new Date(startDate).toISOString(),
                        endDate: new Date(endDate + 'T23:59:59').toISOString()
                    };
                    
                    if (application) {
                        filters.applicationType = application;
                    }

                    // Usar o novo analisador de relat√≥rios para an√°lise avan√ßada
                    console.log('üìä Iniciando an√°lise avan√ßada de relat√≥rios...');
                    
                    // An√°lise de padr√µes de uso (Requirement 6.2)
                    const usagePatterns = await reportAnalyzer.identifyUsagePatterns(filters);
                    
                    // An√°lise de performance do sistema (Requirement 6.3)
                    const performanceAnalysis = await reportAnalyzer.analyzeSystemPerformance(filters);
                    
                    // M√©tricas de gera√ß√£o de etiquetas (Requirement 6.5)
                    const generationMetrics = await reportAnalyzer.calculateLabelGenerationMetrics(filters);
                    
                    // Obter dados b√°sicos para compatibilidade
                    const stats = await supabaseManager.getStatistics(filters);
                    
                    // Armazenar dados do relat√≥rio para exporta√ß√£o
                    this.currentReportData = {
                        filters,
                        stats,
                        usagePatterns,
                        performanceAnalysis,
                        generationMetrics,
                        generatedAt: new Date().toISOString(),
                        period: {
                            startDate,
                            endDate,
                            application: application || 'Todas as aplica√ß√µes'
                        }
                    };

                    // Gerar resumo do per√≠odo (Requirement 6.1)
                    this.generateAdvancedReportSummary(stats, usagePatterns, performanceAnalysis, generationMetrics, startDate, endDate, application);
                    
                    // Analisar padr√µes de uso avan√ßados (Requirement 6.2, 6.3)
                    await this.displayAdvancedUsagePatterns(usagePatterns, performanceAnalysis, generationMetrics);

                    console.log('‚úÖ Relat√≥rio avan√ßado gerado com sucesso');

                } catch (error) {
                    console.error('‚ùå Erro ao gerar relat√≥rio:', error);
                    document.getElementById('summaryStats').innerHTML = '<div class="error-state"><div class="error-icon">‚ùå</div><p>Erro ao gerar relat√≥rio</p></div>';
                    document.getElementById('patternsContent').innerHTML = '<div class="error-state"><div class="error-icon">‚ùå</div><p>Erro ao analisar padr√µes</p></div>';
                }
            }

            /**
             * Gerar resumo estat√≠stico avan√ßado do per√≠odo
             * Requirement 6.1: Usage summaries by time period
             */
            generateAdvancedReportSummary(stats, usagePatterns, performanceAnalysis, generationMetrics, startDate, endDate, application) {
                const summaryStats = document.getElementById('summaryStats');
                
                // Calcular estat√≠sticas do per√≠odo
                const totalDays = Math.ceil((new Date(endDate) - new Date(startDate)) / (1000 * 60 * 60 * 24)) + 1;
                
                const appNames = {
                    'placas': 'Etiquetas de Produto',
                    'caixa': 'Etiquetas de Caixa',
                    'avulso': 'Volume Avulso',
                    'enderec': 'Endere√ßamento',
                    'transfer': 'Transfer√™ncia',
                    'termo': 'Termol√°beis',
                    'pedido-direto': 'Pedido Direto',
                    'etiqueta-mercadoria': 'Etiqueta de Mercadoria',
                    'inventario': 'Invent√°rio'
                };

                const summaryHTML = `
                    <div class="summary-stat">
                        <div class="summary-stat-label">Total de Etiquetas</div>
                        <div class="summary-stat-value">${generationMetrics.summary.totalGenerated.toLocaleString('pt-BR')}</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-label">Per√≠odo Analisado</div>
                        <div class="summary-stat-value">${totalDays} dias</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-label">M√©dia Di√°ria</div>
                        <div class="summary-stat-value">${generationMetrics.summary.avgPerDay}</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-label">Performance Geral</div>
                        <div class="summary-stat-value">${performanceAnalysis.summary.overallScore}%</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-label">Aplica√ß√£o L√≠der</div>
                        <div class="summary-stat-value">${appNames[generationMetrics.summary.mostUsedApp] || generationMetrics.summary.mostUsedApp}</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-label">Tend√™ncia</div>
                        <div class="summary-stat-value">${generationMetrics.summary.trendDirection}</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-label">Taxa de Utiliza√ß√£o</div>
                        <div class="summary-stat-value">${performanceAnalysis.summary.utilizationRate}%</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-label">Qualidade dos Dados</div>
                        <div class="summary-stat-value">${generationMetrics.summary.qualityScore}%</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-label">Per√≠odos Ativos</div>
                        <div class="summary-stat-value">${usagePatterns.summary.activePeriods}</div>
                    </div>
                    <div class="summary-stat">
                        <div class="summary-stat-label">Anomalias Detectadas</div>
                        <div class="summary-stat-value">${usagePatterns.summary.anomalyCount}</div>
                    </div>
                `;
                
                summaryStats.innerHTML = summaryHTML;
            }

            /**
             * Exibir padr√µes de uso avan√ßados
             * Requirements 6.2: Peak usage times and popular applications
             * Requirements 6.3: Generation speed and error rates
             */
            async displayAdvancedUsagePatterns(usagePatterns, performanceAnalysis, generationMetrics) {
                const patternsContent = document.getElementById('patternsContent');
                
                try {
                    const appNames = {
                        'placas': 'Etiquetas de Produto',
                        'caixa': 'Etiquetas de Caixa',
                        'avulso': 'Volume Avulso',
                        'enderec': 'Endere√ßamento',
                        'transfer': 'Transfer√™ncia',
                        'termo': 'Termol√°beis',
                        'pedido-direto': 'Pedido Direto',
                        'etiqueta-mercadoria': 'Etiqueta de Mercadoria',
                        'inventario': 'Invent√°rio'
                    };

                    let patternsHTML = '';
                    
                    // Padr√µes temporais
                    if (usagePatterns.temporal.peakDays.length > 0) {
                        const peakDay = usagePatterns.temporal.peakDays[0];
                        patternsHTML += `
                            <div class="pattern-item">
                                <div class="pattern-label">Dia de Maior Atividade</div>
                                <div class="pattern-value">${new Date(peakDay.date).toLocaleDateString('pt-BR')} (${peakDay.count} etiquetas)</div>
                            </div>
                        `;
                    }
                    
                    // Aplica√ß√£o dominante com detalhes
                    const dominantApp = usagePatterns.applications.dominant;
                    if (dominantApp.name !== 'N/A') {
                        patternsHTML += `
                            <div class="pattern-item">
                                <div class="pattern-label">Aplica√ß√£o Dominante</div>
                                <div class="pattern-value">${appNames[dominantApp.name] || dominantApp.name} (${dominantApp.count.toLocaleString('pt-BR')} etiquetas)</div>
                            </div>
                        `;
                    }
                    
                    // Concentra√ß√£o de uso
                    patternsHTML += `
                        <div class="pattern-item">
                            <div class="pattern-label">Distribui√ß√£o de Uso</div>
                            <div class="pattern-value">${usagePatterns.applications.concentration.type}</div>
                        </div>
                    `;
                    
                    // Tend√™ncia de crescimento
                    patternsHTML += `
                        <div class="pattern-item">
                            <div class="pattern-label">Taxa de Crescimento</div>
                            <div class="pattern-value">${usagePatterns.growth.overallRate}% (${usagePatterns.growth.direction})</div>
                        </div>
                    `;
                    
                    // M√©tricas de performance
                    patternsHTML += `
                        <div class="pattern-item">
                            <div class="pattern-label">Throughput M√©dio</div>
                            <div class="pattern-value">${performanceAnalysis.summary.avgThroughput} etiquetas/dia</div>
                        </div>
                    `;
                    
                    patternsHTML += `
                        <div class="pattern-item">
                            <div class="pattern-label">Consist√™ncia do Sistema</div>
                            <div class="pattern-value">${performanceAnalysis.throughput.consistency}%</div>
                        </div>
                    `;
                    
                    // Efici√™ncia por aplica√ß√£o
                    if (performanceAnalysis.efficiency.peak.name !== 'N/A') {
                        patternsHTML += `
                            <div class="pattern-item">
                                <div class="pattern-label">Aplica√ß√£o Mais Eficiente</div>
                                <div class="pattern-value">${appNames[performanceAnalysis.efficiency.peak.name] || performanceAnalysis.efficiency.peak.name} (${performanceAnalysis.efficiency.peak.efficiency}%)</div>
                            </div>
                        `;
                    }
                    
                    // Balanceamento de carga
                    patternsHTML += `
                        <div class="pattern-item">
                            <div class="pattern-label">Balanceamento de Carga</div>
                            <div class="pattern-value">${performanceAnalysis.loadDistribution.balance}</div>
                        </div>
                    `;
                    
                    // Sazonalidade
                    if (usagePatterns.seasonality.hasSeasonality) {
                        patternsHTML += `
                            <div class="pattern-item">
                                <div class="pattern-label">Padr√£o Sazonal</div>
                                <div class="pattern-value">Detectado (varia√ß√£o: ${usagePatterns.seasonality.patterns.averageVariation})</div>
                            </div>
                        `;
                    }
                    
                    // Anomalias
                    if (usagePatterns.anomalies.length > 0) {
                        const highSeverityAnomalies = usagePatterns.anomalies.filter(a => a.severity === 'high').length;
                        patternsHTML += `
                            <div class="pattern-item">
                                <div class="pattern-label">Anomalias Cr√≠ticas</div>
                                <div class="pattern-value">${highSeverityAnomalies} de ${usagePatterns.anomalies.length} total</div>
                            </div>
                        `;
                    }
                    
                    // Gargalos identificados
                    if (performanceAnalysis.bottlenecks.length > 0) {
                        const criticalBottlenecks = performanceAnalysis.bottlenecks.filter(b => b.severity === 'high').length;
                        patternsHTML += `
                            <div class="pattern-item">
                                <div class="pattern-label">Gargalos Cr√≠ticos</div>
                                <div class="pattern-value">${criticalBottlenecks} identificados</div>
                            </div>
                        `;
                    }
                    
                    // Benchmark de performance
                    patternsHTML += `
                        <div class="pattern-item">
                            <div class="pattern-label">Benchmark da Ind√∫stria</div>
                            <div class="pattern-value">${generationMetrics.benchmarks.comparison} (${generationMetrics.benchmarks.overallScore}%)</div>
                        </div>
                    `;
                    
                    patternsContent.innerHTML = patternsHTML;

                } catch (error) {
                    console.error('‚ùå Erro ao exibir padr√µes avan√ßados:', error);
                    patternsContent.innerHTML = '<div class="error-state"><div class="error-icon">‚ùå</div><p>Erro ao exibir padr√µes avan√ßados</p></div>';
                }
            }

            /**
             * Analisar padr√µes de uso e performance
             * Requirements 6.2: Peak usage times and popular applications
             * Requirements 6.3: Generation speed and error rates
             */
            async analyzeUsagePatterns(stats, filters) {
                const patternsContent = document.getElementById('patternsContent');
                
                try {
                    // Obter dados detalhados para an√°lise de padr√µes
                    const detailedStats = await this.getDetailedPatternAnalysis(filters);
                    
                    // Analisar hor√°rios de pico
                    const peakHours = this.analyzePeakUsageTimes(stats.timeSeriesData);
                    
                    // Analisar aplica√ß√µes populares
                    const popularApps = this.analyzePopularApplications(stats.applicationBreakdown);
                    
                    // Calcular m√©tricas de performance
                    const performanceMetrics = this.calculatePerformanceMetrics(stats, filters);

                    const appNames = {
                        'placas': 'Etiquetas de Produto',
                        'caixa': 'Etiquetas de Caixa',
                        'avulso': 'Volume Avulso',
                        'enderec': 'Endere√ßamento',
                        'transfer': 'Transfer√™ncia',
                        'termo': 'Termol√°beis',
                        'pedido-direto': 'Pedido Direto',
                        'etiqueta-mercadoria': 'Etiqueta de Mercadoria',
                        'inventario': 'Invent√°rio'
                    };

                    let patternsHTML = '';
                    
                    // Hor√°rios de pico
                    if (peakHours.length > 0) {
                        patternsHTML += `
                            <div class="pattern-item">
                                <div class="pattern-label">Hor√°rio de Maior Uso</div>
                                <div class="pattern-value">${peakHours[0].period}</div>
                            </div>
                        `;
                    }
                    
                    // Aplica√ß√µes mais populares
                    popularApps.slice(0, 3).forEach((app, index) => {
                        const percentage = ((app.count / stats.totalLabels) * 100).toFixed(1);
                        patternsHTML += `
                            <div class="pattern-item">
                                <div class="pattern-label">${index === 0 ? 'Aplica√ß√£o L√≠der' : `${index + 1}¬™ Mais Usada`}</div>
                                <div class="pattern-value">${appNames[app.name] || app.name} (${percentage}%)</div>
                            </div>
                        `;
                    });
                    
                    // M√©tricas de performance
                    patternsHTML += `
                        <div class="pattern-item">
                            <div class="pattern-label">M√©dia de Etiquetas por Gera√ß√£o</div>
                            <div class="pattern-value">${performanceMetrics.avgLabelsPerGeneration.toFixed(1)}</div>
                        </div>
                        <div class="pattern-item">
                            <div class="pattern-label">Dias com Atividade</div>
                            <div class="pattern-value">${performanceMetrics.activeDays} de ${performanceMetrics.totalDays}</div>
                        </div>
                        <div class="pattern-item">
                            <div class="pattern-label">Taxa de Utiliza√ß√£o</div>
                            <div class="pattern-value">${performanceMetrics.utilizationRate.toFixed(1)}%</div>
                        </div>
                    `;
                    
                    patternsContent.innerHTML = patternsHTML;

                } catch (error) {
                    console.error('‚ùå Erro ao analisar padr√µes:', error);
                    patternsContent.innerHTML = '<div class="error-state"><div class="error-icon">‚ùå</div><p>Erro ao analisar padr√µes</p></div>';
                }
            }

            /**
             * Obter an√°lise detalhada de padr√µes
             */
            async getDetailedPatternAnalysis(filters) {
                // Para an√°lise mais detalhada, podemos fazer queries espec√≠ficas
                // Por enquanto, usar os dados j√° obtidos
                return {};
            }

            /**
             * Analisar hor√°rios de pico de uso
             */
            analyzePeakUsageTimes(timeSeriesData) {
                if (!timeSeriesData || timeSeriesData.length === 0) {
                    return [];
                }
                
                // Agrupar por per√≠odo do dia (manh√£, tarde, noite)
                const periods = {
                    'Manh√£ (06:00-12:00)': 0,
                    'Tarde (12:00-18:00)': 0,
                    'Noite (18:00-00:00)': 0,
                    'Madrugada (00:00-06:00)': 0
                };
                
                // Para dados di√°rios, assumir distribui√ß√£o uniforme
                // Em implementa√ß√£o real, seria necess√°rio dados por hora
                const totalCount = timeSeriesData.reduce((sum, day) => sum + day.count, 0);
                
                // Simular distribui√ß√£o baseada em padr√µes t√≠picos de uso comercial
                periods['Manh√£ (06:00-12:00)'] = Math.round(totalCount * 0.4);
                periods['Tarde (12:00-18:00)'] = Math.round(totalCount * 0.45);
                periods['Noite (18:00-00:00)'] = Math.round(totalCount * 0.13);
                periods['Madrugada (00:00-06:00)'] = Math.round(totalCount * 0.02);
                
                return Object.entries(periods)
                    .map(([period, count]) => ({ period, count }))
                    .sort((a, b) => b.count - a.count);
            }

            /**
             * Analisar aplica√ß√µes mais populares
             */
            analyzePopularApplications(applicationBreakdown) {
                return Object.entries(applicationBreakdown)
                    .map(([name, count]) => ({ name, count }))
                    .sort((a, b) => b.count - a.count);
            }

            /**
             * Calcular m√©tricas de performance
             */
            calculatePerformanceMetrics(stats, filters) {
                const startDate = new Date(filters.startDate);
                const endDate = new Date(filters.endDate);
                const totalDays = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                
                // Calcular dias com atividade
                const activeDays = stats.timeSeriesData ? stats.timeSeriesData.length : 0;
                
                // Calcular m√©dia de etiquetas por gera√ß√£o (estimativa)
                const totalGenerations = Object.values(stats.applicationBreakdown).reduce((sum, count) => sum + count, 0);
                const avgLabelsPerGeneration = totalGenerations > 0 ? stats.totalLabels / totalGenerations : 0;
                
                // Taxa de utiliza√ß√£o (dias com atividade / total de dias)
                const utilizationRate = totalDays > 0 ? (activeDays / totalDays) * 100 : 0;
                
                return {
                    totalDays,
                    activeDays,
                    avgLabelsPerGeneration,
                    utilizationRate,
                    totalGenerations
                };
            }

            /**
             * Exportar relat√≥rio em formato CSV ou JSON
             * Requirement 6.4: CSV and JSON export options
             */
            async exportReport(format) {
                if (!this.currentReportData) {
                    alert('Por favor, gere um relat√≥rio primeiro antes de exportar.');
                    return;
                }

                try {
                    const { stats, period, generatedAt } = this.currentReportData;
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    const filename = `relatorio-hub-etiquetas-${timestamp}`;

                    if (format === 'csv') {
                        this.exportToCSV(stats, period, generatedAt, filename);
                    } else if (format === 'json') {
                        this.exportToJSON(this.currentReportData, filename);
                    }

                    console.log(`‚úÖ Relat√≥rio exportado em formato ${format.toUpperCase()}`);

                } catch (error) {
                    console.error(`‚ùå Erro ao exportar relat√≥rio em ${format}:`, error);
                    alert(`Erro ao exportar relat√≥rio em ${format.toUpperCase()}. Tente novamente.`);
                }
            }

            /**
             * Exportar dados para CSV com an√°lise avan√ßada
             */
            exportToCSV(stats, period, generatedAt, filename) {
                const appNames = {
                    'placas': 'Etiquetas de Produto',
                    'caixa': 'Etiquetas de Caixa',
                    'avulso': 'Volume Avulso',
                    'enderec': 'Endere√ßamento',
                    'transfer': 'Transfer√™ncia',
                    'termo': 'Termol√°beis',
                    'pedido-direto': 'Pedido Direto',
                    'etiqueta-mercadoria': 'Etiqueta de Mercadoria',
                    'inventario': 'Invent√°rio'
                };

                // Cabe√ßalho do relat√≥rio
                let csvContent = 'Relat√≥rio Avan√ßado Hub de Etiquetas\n';
                csvContent += `Gerado em,${new Date(generatedAt).toLocaleString('pt-BR')}\n`;
                csvContent += `Per√≠odo,${period.startDate} a ${period.endDate}\n`;
                csvContent += `Filtro,${period.application}\n\n`;

                // Resumo geral
                csvContent += 'RESUMO GERAL\n';
                csvContent += 'M√©trica,Valor\n';
                csvContent += `Total de Etiquetas,${stats.totalLabels}\n`;
                csvContent += `Aplica√ß√µes Ativas,${Object.keys(stats.applicationBreakdown).length}\n`;
                
                // Adicionar dados de an√°lise avan√ßada se dispon√≠vel
                if (this.currentReportData.usagePatterns) {
                    csvContent += `Taxa de Crescimento,${this.currentReportData.usagePatterns.growth.overallRate}%\n`;
                    csvContent += `Dire√ß√£o da Tend√™ncia,${this.currentReportData.usagePatterns.growth.direction}\n`;
                    csvContent += `Anomalias Detectadas,${this.currentReportData.usagePatterns.anomalies.length}\n`;
                }
                
                if (this.currentReportData.performanceAnalysis) {
                    csvContent += `Score de Performance,${this.currentReportData.performanceAnalysis.summary.overallScore}%\n`;
                    csvContent += `Taxa de Utiliza√ß√£o,${this.currentReportData.performanceAnalysis.summary.utilizationRate}%\n`;
                    csvContent += `Throughput M√©dio,${this.currentReportData.performanceAnalysis.summary.avgThroughput}\n`;
                }
                
                csvContent += '\n';

                // Breakdown por aplica√ß√£o
                csvContent += 'BREAKDOWN POR APLICA√á√ÉO\n';
                csvContent += 'Aplica√ß√£o,Etiquetas,Percentual\n';
                
                Object.entries(stats.applicationBreakdown)
                    .sort(([,a], [,b]) => b - a)
                    .forEach(([app, count]) => {
                        const percentage = ((count / stats.totalLabels) * 100).toFixed(2);
                        const appName = appNames[app] || app;
                        csvContent += `${appName},${count},${percentage}%\n`;
                    });

                // An√°lise de padr√µes avan√ßada
                if (this.currentReportData.usagePatterns) {
                    csvContent += '\nPADR√ïES DE USO\n';
                    csvContent += 'M√©trica,Valor\n';
                    csvContent += `Per√≠odos Ativos,${this.currentReportData.usagePatterns.summary.activePeriods}\n`;
                    csvContent += `Aplica√ß√£o Dominante,${appNames[this.currentReportData.usagePatterns.applications.dominant.name] || this.currentReportData.usagePatterns.applications.dominant.name}\n`;
                    csvContent += `Tipo de Distribui√ß√£o,${this.currentReportData.usagePatterns.applications.concentration.type}\n`;
                    
                    if (this.currentReportData.usagePatterns.temporal.peakDays.length > 0) {
                        csvContent += '\nDIAS DE PICO\n';
                        csvContent += 'Data,Etiquetas,% Acima da M√©dia\n';
                        this.currentReportData.usagePatterns.temporal.peakDays.forEach(peak => {
                            const date = new Date(peak.date).toLocaleDateString('pt-BR');
                            csvContent += `${date},${peak.count},${peak.percentageAboveAvg}%\n`;
                        });
                    }
                }

                // M√©tricas de performance
                if (this.currentReportData.performanceAnalysis) {
                    csvContent += '\nM√âTRICAS DE PERFORMANCE\n';
                    csvContent += 'M√©trica,Valor\n';
                    csvContent += `Consist√™ncia,${this.currentReportData.performanceAnalysis.throughput.consistency}%\n`;
                    csvContent += `Balanceamento,${this.currentReportData.performanceAnalysis.loadDistribution.balance}\n`;
                    csvContent += `Efici√™ncia M√©dia,${this.currentReportData.performanceAnalysis.efficiency.average}%\n`;
                    
                    if (this.currentReportData.performanceAnalysis.bottlenecks.length > 0) {
                        csvContent += '\nGARGALOS IDENTIFICADOS\n';
                        csvContent += 'Tipo,Descri√ß√£o,Severidade\n';
                        this.currentReportData.performanceAnalysis.bottlenecks.forEach(bottleneck => {
                            csvContent += `${bottleneck.type},${bottleneck.description},${bottleneck.severity}\n`;
                        });
                    }
                }

                // Dados por dia (se dispon√≠vel)
                if (stats.timeSeriesData && stats.timeSeriesData.length > 0) {
                    csvContent += '\nDADOS DI√ÅRIOS\n';
                    csvContent += 'Data,Etiquetas\n';
                    
                    stats.timeSeriesData
                        .sort((a, b) => new Date(a.date) - new Date(b.date))
                        .forEach(day => {
                            const date = new Date(day.date).toLocaleDateString('pt-BR');
                            csvContent += `${date},${day.count}\n`;
                        });
                }

                // Criar e baixar arquivo
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `${filename}.csv`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            /**
             * Exportar dados para JSON com an√°lise avan√ßada
             */
            exportToJSON(reportData, filename) {
                // Estruturar dados para JSON com an√°lise avan√ßada
                const jsonData = {
                    metadata: {
                        title: 'Relat√≥rio Avan√ßado Hub de Etiquetas',
                        generatedAt: reportData.generatedAt,
                        period: reportData.period,
                        version: '2.0',
                        analysisType: 'advanced'
                    },
                    summary: {
                        totalLabels: reportData.stats.totalLabels,
                        activeApplications: Object.keys(reportData.stats.applicationBreakdown).length,
                        reportPeriodDays: Math.ceil((new Date(reportData.period.endDate) - new Date(reportData.period.startDate)) / (1000 * 60 * 60 * 24)) + 1
                    },
                    basicData: {
                        applicationBreakdown: reportData.stats.applicationBreakdown,
                        timeSeriesData: reportData.stats.timeSeriesData || [],
                        filters: reportData.filters
                    },
                    advancedAnalysis: {
                        usagePatterns: reportData.usagePatterns || null,
                        performanceAnalysis: reportData.performanceAnalysis || null,
                        generationMetrics: reportData.generationMetrics || null
                    },
                    insights: {
                        keyFindings: this.generateKeyFindings(reportData),
                        recommendations: this.generateRecommendations(reportData),
                        riskFactors: this.identifyRiskFactors(reportData)
                    }
                };

                // Criar e baixar arquivo
                const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `${filename}.json`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            /**
             * Gerar insights principais do relat√≥rio
             */
            generateKeyFindings(reportData) {
                const findings = [];
                
                if (reportData.usagePatterns) {
                    // Tend√™ncia de crescimento
                    if (Math.abs(parseFloat(reportData.usagePatterns.growth.overallRate)) > 10) {
                        findings.push({
                            type: 'trend',
                            description: `Sistema apresenta ${reportData.usagePatterns.growth.direction} de ${reportData.usagePatterns.growth.overallRate}%`,
                            impact: 'high'
                        });
                    }
                    
                    // Concentra√ß√£o de uso
                    if (reportData.usagePatterns.applications.concentration.type === 'Altamente concentrada') {
                        findings.push({
                            type: 'concentration',
                            description: `Uso altamente concentrado na aplica√ß√£o ${reportData.usagePatterns.applications.dominant.name}`,
                            impact: 'medium'
                        });
                    }
                    
                    // Anomalias
                    if (reportData.usagePatterns.anomalies.length > 0) {
                        const highSeverity = reportData.usagePatterns.anomalies.filter(a => a.severity === 'high').length;
                        if (highSeverity > 0) {
                            findings.push({
                                type: 'anomaly',
                                description: `${highSeverity} anomalias cr√≠ticas detectadas no per√≠odo`,
                                impact: 'high'
                            });
                        }
                    }
                }
                
                if (reportData.performanceAnalysis) {
                    // Performance geral
                    const overallScore = parseFloat(reportData.performanceAnalysis.summary.overallScore);
                    if (overallScore < 60) {
                        findings.push({
                            type: 'performance',
                            description: `Performance do sistema abaixo do esperado (${overallScore}%)`,
                            impact: 'high'
                        });
                    } else if (overallScore > 85) {
                        findings.push({
                            type: 'performance',
                            description: `Excelente performance do sistema (${overallScore}%)`,
                            impact: 'positive'
                        });
                    }
                }
                
                return findings;
            }

            /**
             * Gerar recomenda√ß√µes baseadas na an√°lise
             */
            generateRecommendations(reportData) {
                const recommendations = [];
                
                if (reportData.performanceAnalysis && reportData.performanceAnalysis.bottlenecks.length > 0) {
                    reportData.performanceAnalysis.bottlenecks.forEach(bottleneck => {
                        recommendations.push({
                            category: 'performance',
                            priority: bottleneck.severity === 'high' ? 'alta' : 'm√©dia',
                            description: bottleneck.recommendation,
                            context: bottleneck.description
                        });
                    });
                }
                
                if (reportData.usagePatterns) {
                    // Recomenda√ß√µes baseadas em padr√µes
                    if (reportData.usagePatterns.applications.concentration.type === 'Altamente concentrada') {
                        recommendations.push({
                            category: 'distribution',
                            priority: 'm√©dia',
                            description: 'Considerar estrat√©gias para distribuir melhor o uso entre aplica√ß√µes',
                            context: 'Concentra√ß√£o excessiva pode criar pontos √∫nicos de falha'
                        });
                    }
                    
                    if (reportData.usagePatterns.growth.direction === 'crescimento' && parseFloat(reportData.usagePatterns.growth.overallRate) > 20) {
                        recommendations.push({
                            category: 'capacity',
                            priority: 'alta',
                            description: 'Planejar aumento de capacidade devido ao crescimento acelerado',
                            context: `Taxa de crescimento de ${reportData.usagePatterns.growth.overallRate}% indica necessidade de expans√£o`
                        });
                    }
                }
                
                return recommendations;
            }

            /**
             * Identificar fatores de risco
             */
            identifyRiskFactors(reportData) {
                const risks = [];
                
                if (reportData.performanceAnalysis) {
                    // Riscos de performance
                    const utilizationRate = parseFloat(reportData.performanceAnalysis.summary.utilizationRate);
                    if (utilizationRate > 90) {
                        risks.push({
                            type: 'capacity',
                            level: 'high',
                            description: 'Taxa de utiliza√ß√£o muito alta pode levar √† sobrecarga',
                            probability: 'alta'
                        });
                    }
                    
                    // Riscos de gargalos
                    const criticalBottlenecks = reportData.performanceAnalysis.bottlenecks.filter(b => b.severity === 'high').length;
                    if (criticalBottlenecks > 0) {
                        risks.push({
                            type: 'bottleneck',
                            level: 'high',
                            description: `${criticalBottlenecks} gargalos cr√≠ticos podem impactar a opera√ß√£o`,
                            probability: 'm√©dia'
                        });
                    }
                }
                
                if (reportData.usagePatterns) {
                    // Riscos de concentra√ß√£o
                    const dominantPercentage = reportData.usagePatterns.applications.dominant.count / reportData.stats.totalLabels * 100;
                    if (dominantPercentage > 80) {
                        risks.push({
                            type: 'dependency',
                            level: 'medium',
                            description: 'Depend√™ncia excessiva de uma √∫nica aplica√ß√£o',
                            probability: 'm√©dia'
                        });
                    }
                }
                
                return risks;
            }
                    },
                    applicationBreakdown: reportData.stats.applicationBreakdown,
                    timeSeriesData: reportData.stats.timeSeriesData || [],
                    filters: reportData.filters,
                    patterns: {
                        popularApplications: this.analyzePopularApplications(reportData.stats.applicationBreakdown),
                        peakUsageTimes: this.analyzePeakUsageTimes(reportData.stats.timeSeriesData),
                        performanceMetrics: this.calculatePerformanceMetrics(reportData.stats, reportData.filters)
                    }
                };

                // Criar e baixar arquivo
                const blob = new Blob([JSON.stringify(jsonData, null, 2)], { type: 'application/json' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                link.setAttribute('href', url);
                link.setAttribute('download', `${filename}.json`);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            /**
             * Configurar datas padr√£o para relat√≥rios
             */
            setupDefaultReportDates() {
                const today = new Date();
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(today.getDate() - 30);
                
                document.getElementById('reportEndDate').value = today.toISOString().split('T')[0];
                document.getElementById('reportStartDate').value = thirtyDaysAgo.toISOString().split('T')[0];
            }
        }

        // Inicializar dashboard
        new AdminDashboard();
    </script>
</body>
</html>